<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§ - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item active">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§</h1>
                <div class="header-actions">
                    <button onclick="openProductModal()" class="btn btn-primary">+ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</button>
                </div>
            </header>

            <div class="content-section">
                <div class="filters">
                    <select id="categoryFilter" onchange="filterProducts()">
                        <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
                    </select>
                    <select id="activeFilter" onchange="filterProducts()">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="true">ÙØ¹Ø§Ù„</option>
                        <option value="false">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ú©Ø¯ Ú©Ø§Ù„Ø§</th>
                                <th>Ù†Ø§Ù…</th>
                                <th>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th>
                                <th>ÙˆØ§Ø­Ø¯</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="6" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§ -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
                <button onclick="closeProductModal()" class="modal-close">&times;</button>
            </div>
            <form id="productForm" class="modal-form">
                <input type="hidden" id="productId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="code">Ú©Ø¯ Ú©Ø§Ù„Ø§ *</label>
                        <input type="text" id="code" required>
                    </div>
                    <div class="form-group">
                        <label for="name">Ù†Ø§Ù… Ú©Ø§Ù„Ø§ *</label>
                        <input type="text" id="name" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                    <textarea id="description" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                        <input type="text" id="category" list="categories">
                        <datalist id="categories"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="unit">ÙˆØ§Ø­Ø¯</label>
                        <select id="unit">
                            <option value="Ø¹Ø¯Ø¯">Ø¹Ø¯Ø¯</option>
                            <option value="Ø¨Ø³ØªÙ‡">Ø¨Ø³ØªÙ‡</option>
                            <option value="Ú©Ø§Ø±ØªÙ†">Ú©Ø§Ø±ØªÙ†</option>
                            <option value="Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…">Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</option>
                            <option value="Ù„ÛŒØªØ±">Ù„ÛŒØªØ±</option>
                            <option value="Ù…ØªØ±">Ù…ØªØ±</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is_active" checked>
                        <span>ÙØ¹Ø§Ù„</span>
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button type="button" onclick="closeProductModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="api.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            initializeMenu();
        })();

        let editingProductId = null;

        async function loadProducts() {
            try {
                const result = await productsAPI.getAll();
                
                if (result.success && result.products) {
                    displayProducts(result.products);
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù„Ø§Ù‡Ø§:', result);
                    displayProducts([]);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§:', error);
                displayProducts([]);
            }
        }

        async function loadCategories() {
            try {
                const result = await productsAPI.getCategories();
                
                if (result.success && result.categories) {
                    const datalist = document.getElementById('categories');
                    datalist.innerHTML = result.categories.map(cat => `<option value="${cat}">`).join('');
                    
                    const filter = document.getElementById('categoryFilter');
                    filter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>' +
                        result.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§:', error);
            }
        }

        function displayProducts(products) {
            const tbody = document.getElementById('productsTableBody');

            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.category || '-'}</td>
                    <td>${product.unit}</td>
                    <td><span class="badge badge-${product.is_active ? 'completed' : 'cancelled'}">${product.is_active ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</span></td>
                    <td>
                        <button onclick="editProduct(${product.id})" class="btn-icon" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                        <button onclick="deleteProduct(${product.id})" class="btn-icon" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const modalTitle = document.getElementById('modalTitle');
            
            form.reset();
            editingProductId = productId;
            loadCategories();

            if (productId) {
                modalTitle.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§';
                loadProductData(productId);
            } else {
                modalTitle.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯';
                document.getElementById('is_active').checked = true;
            }

            modal.style.display = 'flex';
        }

        async function loadProductData(productId) {
            try {
                const result = await productsAPI.getAll();
                
                if (!result.success || !result.products) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù„Ø§');
                    return;
                }
                
                const product = result.products.find(p => p.id === productId);
                
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('code').value = product.code;
                    document.getElementById('name').value = product.name;
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('category').value = product.category || '';
                    document.getElementById('unit').value = product.unit;
                    document.getElementById('is_active').checked = product.is_active;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù„Ø§:', error);
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const productData = {
                code: document.getElementById('code').value,
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                unit: document.getElementById('unit').value,
                is_active: document.getElementById('is_active').checked
            };

            try {
                let result;
                if (editingProductId) {
                    result = await productsAPI.update(editingProductId, productData);
                } else {
                    result = await productsAPI.create(productData);
                }
                
                if (result.success) {
                    closeProductModal();
                    await loadProducts();
                    alert(editingProductId ? 'Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        function editProduct(productId) {
            openProductModal(productId);
        }

        async function deleteProduct(productId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ù„Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;

            try {
                const result = await productsAPI.delete(productId);
                
                if (result.success) {
                    alert('Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    await loadProducts();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ù„Ø§');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        async function filterProducts() {
            const category = document.getElementById('categoryFilter').value;
            const active = document.getElementById('activeFilter').value;
            
            const filters = {};
            if (category) filters.category = category;
            if (active) filters.active = active;

            try {
                const result = await productsAPI.getAll(filters);
                
                if (result.success && result.products) {
                    displayProducts(result.products);
                } else {
                    displayProducts([]);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†:', error);
                displayProducts([]);
            }
        }

        loadProducts();
        loadCategories();

        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeProductModal();
            }
        }
    </script>
</body>
</html>
