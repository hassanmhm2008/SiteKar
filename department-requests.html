<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item active admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1 id="pageTitle">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯</h1>
            </header>

            <div class="content-section">
                <div class="filters">
                    <select id="statusFilter" onchange="filterRequests()">
                        <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡">Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡</option>
                        <option value="Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯" selected>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</option>
                        <option value="ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</option>
                        <option value="Ø±Ø¯ Ø´Ø¯Ù‡">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                        <option value="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                        <option value="ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                        <option value="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
                                <th>ÙˆØ§Ø­Ø¯</th>
                                <th>Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒØ¯Ù‡Ù†Ø¯Ù‡</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ù„Ø§Ù…</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="8" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="detailsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª #<span id="detailRequestId"></span></h2>
                <button onclick="closeDetailsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="request-info">
                    <p><strong>Ú©Ø§Ø±Ø¨Ø±:</strong> <span id="detailUserName"></span></p>
                    <p><strong>ØªØ§Ø±ÛŒØ®:</strong> <span id="detailDate"></span></p>
                    <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> <span id="detailDescription"></span></p>
                </div>
                
                <h3>Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ:</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø±Ø¯ÛŒÙ</th>
                                <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="detailItemsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDetailsModal()" class="btn btn-secondary">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <!-- Modal ØªØ§ÛŒÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="approveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªØ§ÛŒÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h2>
                <button onclick="closeApproveModal()" class="modal-close">&times;</button>
            </div>
            <form id="approveForm" class="modal-form">
                <input type="hidden" id="approveRequestId">
                
                <div class="form-group">
                    <label for="approveComment">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="approveComment" rows="4" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">âœ“ ØªØ§ÛŒÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
                    <button type="button" onclick="closeApproveModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h2>
                <button onclick="closeRejectModal()" class="modal-close">&times;</button>
            </div>
            <form id="rejectForm" class="modal-form">
                <input type="hidden" id="rejectRequestId">
                
                <div class="form-group">
                    <label for="rejectComment">Ø¯Ù„ÛŒÙ„ Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="rejectComment" rows="4" placeholder="Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¯Ù„ÛŒÙ„ Ø±Ø¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">âœ— Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
                    <button type="button" onclick="closeRejectModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ú¯Ø´Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="returnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â†©ï¸ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h2>
                <button onclick="closeReturnModal()" class="modal-close">&times;</button>
            </div>
            <form id="returnForm" class="modal-form">
                <input type="hidden" id="returnRequestId">
                
                <div class="form-group">
                    <label for="returnComment">Ø¯Ù„ÛŒÙ„ Ø¨Ø±Ú¯Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="returnComment" rows="4" placeholder="Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¯Ù„ÛŒÙ„ Ø¨Ø±Ú¯Ø´Øª Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">â†©ï¸ Ø¨Ø±Ú¯Ø´Øª</button>
                    <button type="button" onclick="closeReturnModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="api.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            initializeMenu();
            await loadDepartmentRequests();
        })();

        let allRequests = [];
        let currentRequestId = null;

        async function loadDepartmentRequests() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const statusFilter = document.getElementById('statusFilter').value;
                
                // Ø§Ú¯Ø± Ù…Ø¯ÛŒØ± Ø§Ø³ØªØŒ Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                let apiUrl;
                if (currentUser.role === 'Ù…Ø¯ÛŒØ±') {
                    apiUrl = statusFilter 
                        ? `http://localhost:3000/api/requests?status=${encodeURIComponent(statusFilter)}`
                        : 'http://localhost:3000/api/requests';
                } else {
                    // Ø¨Ø±Ø§ÛŒ Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯ Ø®ÙˆØ¯Ø´
                    if (!currentUser.department_id) {
                        document.getElementById('requestsTableBody').innerHTML = 
                            '<tr><td colspan="8" class="empty-state">Ø´Ù…Ø§ Ø¨Ù‡ Ù‡ÛŒÚ† ÙˆØ§Ø­Ø¯ÛŒ ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯</td></tr>';
                        return;
                    }
                    apiUrl = statusFilter
                        ? `http://localhost:3000/api/requests?department_id=${currentUser.department_id}&status=${encodeURIComponent(statusFilter)}`
                        : `http://localhost:3000/api/requests?department_id=${currentUser.department_id}`;
                }

                const response = await fetch(apiUrl);
                const result = await response.json();

                if (result.success && result.requests) {
                    allRequests = result.requests;
                    displayRequests();
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function filterRequests() {
            loadDepartmentRequests();
        }

        function displayRequests() {
            const tbody = document.getElementById('requestsTableBody');
            
            if (allRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }

            tbody.innerHTML = allRequests.map(request => {
                const date = new Date(request.created_at).toLocaleDateString('fa-IR');
                
                // ØªØ¹ÛŒÛŒÙ† Ø¨Ø¬ ÙˆØ¶Ø¹ÛŒØª
                let statusBadge = '';
                if (request.status === 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯') {
                    statusBadge = '<span class="badge badge-warning">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</span>';
                } else if (request.status === 'ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³') {
                    statusBadge = '<span class="badge badge-success">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</span>';
                } else if (request.status === 'Ø±Ø¯ Ø´Ø¯Ù‡') {
                    statusBadge = '<span class="badge badge-danger">Ø±Ø¯ Ø´Ø¯Ù‡</span>';
                } else if (request.status === 'ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ') {
                    statusBadge = '<span class="badge badge-info">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</span>';
                } else if (request.status === 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡') {
                    statusBadge = '<span class="badge badge-success">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</span>';
                } else if (request.status === 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡') {
                    statusBadge = '<span class="badge badge-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</span>';
                }
                
                // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯"
                let actionButtons = `
                    <button onclick="viewDetails(${request.id})" class="btn-action btn-info" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª">
                        ğŸ‘ï¸
                    </button>
                `;
                
                if (request.status === 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯') {
                    actionButtons += `
                        <button onclick="openApproveModal(${request.id})" class="btn-action btn-success" title="ØªØ§ÛŒÛŒØ¯">
                            âœ“
                        </button>
                        <button onclick="openRejectModal(${request.id})" class="btn-action btn-danger" title="Ø±Ø¯">
                            âœ—
                        </button>
                    `;
                } else if (request.status === 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡') {
                    // Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ú¯Ø´Øª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
                    actionButtons += `
                        <button onclick="openReturnModal(${request.id})" class="btn-action btn-warning" title="Ø¨Ø±Ú¯Ø´Øª">
                            â†©ï¸ Ø¨Ø±Ú¯Ø´Øª
                        </button>
                    `;
                }
                
                return `
                    <tr>
                        <td>${toPersianNumber(request.id)}</td>
                        <td>${request.department_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                        <td>${request.user_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                        <td>${toPersianNumber(request.items_count || 0)}</td>
                        <td>${date}</td>
                        <td>${statusBadge}</td>
                        <td>${request.description || '-'}</td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function viewDetails(requestId) {
            console.log('viewDetails called with requestId:', requestId);
            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}`);
                const result = await response.json();

                console.log('Details fetched:', result);

                if (result.success && result.request) {
                    const request = result.request;
                    const date = new Date(request.created_at).toLocaleDateString('fa-IR');
                    
                    document.getElementById('detailRequestId').textContent = request.id;
                    document.getElementById('detailUserName').textContent = request.user_name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    document.getElementById('detailDate').textContent = date;
                    document.getElementById('detailDescription').textContent = request.description || 'Ù†Ø¯Ø§Ø±Ø¯';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯")
                    const itemsBody = document.getElementById('detailItemsBody');
                    const isEditable = request.status === 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯';
                    
                    if (request.items && request.items.length > 0) {
                        if (isEditable) {
                            // Ø­Ø§Ù„Øª Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´
                            itemsBody.innerHTML = request.items.map((item, index) => `
                                <tr id="item-row-${item.id}">
                                    <td>${index + 1}</td>
                                    <td>${item.product_name || item.product_code || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                                    <td>
                                        <input type="number" 
                                               id="quantity-${item.id}" 
                                               value="${item.quantity}" 
                                               min="1" 
                                               style="width: 80px; padding: 5px;"
                                               onchange="updateItemQuantity(${request.id}, ${item.id})">
                                    </td>
                                    <td>${item.description || '-'}</td>
                                    <td>
                                        <button onclick="deleteItem(${request.id}, ${item.id})" 
                                                class="btn-action btn-danger" 
                                                title="Ø­Ø°Ù">
                                            ğŸ—‘ï¸
                                        </button>
                                    </td>
                                </tr>
                            `).join('');
                        } else {
                            // Ø­Ø§Ù„Øª ÙÙ‚Ø· Ø®ÙˆØ§Ù†Ø¯Ù†ÛŒ (ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ø´Ø¯Ù‡)
                            itemsBody.innerHTML = request.items.map((item, index) => `
                                <tr>
                                    <td>${toPersianNumber(index + 1)}</td>
                                    <td>${item.product_name || item.product_code || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                                    <td>${toPersianNumber(item.quantity)}</td>
                                    <td>${item.description || '-'}</td>
                                    <td>-</td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        itemsBody.innerHTML = '<tr><td colspan="5" class="empty-state">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù„Ø§Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
                    }
                    
                    document.getElementById('detailsModal').classList.add('active');
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        // ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…
        async function updateItemQuantity(requestId, itemId) {
            const quantityInput = document.getElementById(`quantity-${itemId}`);
            const newQuantity = parseInt(quantityInput.value);

            if (newQuantity < 1) {
                alert('ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQuantity })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ØªØ¹Ø¯Ø§Ø¯ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯');
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¬Ø²Ø¦ÛŒØ§Øª
                    await viewDetails(requestId);
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // Ø­Ø°Ù Ø¢ÛŒØªÙ…
        async function deleteItem(requestId, itemId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯');
                    // Ø­Ø°Ù Ø±Ø¯ÛŒÙ Ø§Ø² Ø¬Ø¯ÙˆÙ„
                    const row = document.getElementById(`item-row-${itemId}`);
                    if (row) row.remove();
                    
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ù„ÛŒØ³Øª
                    await loadDepartmentRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function openApproveModal(requestId) {
            console.log('openApproveModal called with requestId:', requestId);
            currentRequestId = requestId;
            document.getElementById('approveRequestId').value = requestId;
            document.getElementById('approveComment').value = '';
            document.getElementById('approveModal').classList.add('active');
            console.log('Modal should be open now');
        }

        function closeApproveModal() {
            console.log('closeApproveModal called');
            document.getElementById('approveModal').classList.remove('active');
            currentRequestId = null;
        }

        document.getElementById('approveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Approve form submitted');
            
            const requestId = document.getElementById('approveRequestId').value;
            const comment = document.getElementById('approveComment').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            console.log('Approving request:', requestId, 'by user:', currentUser.id);

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comment: comment,
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯');
                    closeApproveModal();
                    await loadDepartmentRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        function openRejectModal(requestId) {
            console.log('openRejectModal called with requestId:', requestId);
            currentRequestId = requestId;
            document.getElementById('rejectRequestId').value = requestId;
            document.getElementById('rejectComment').value = '';
            document.getElementById('rejectModal').classList.add('active');
            console.log('Reject modal should be open now');
        }

        function closeRejectModal() {
            console.log('closeRejectModal called');
            document.getElementById('rejectModal').classList.remove('active');
            currentRequestId = null;
        }

        document.getElementById('rejectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Reject form submitted');
            
            const requestId = document.getElementById('rejectRequestId').value;
            const comment = document.getElementById('rejectComment').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            console.log('Rejecting request:', requestId, 'by user:', currentUser.id);

            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±Ø¯ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comment: comment,
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø¯ Ø´Ø¯');
                    closeRejectModal();
                    await loadDepartmentRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        // ØªÙˆØ§Ø¨Ø¹ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        function openReturnModal(requestId) {
            console.log('openReturnModal called with requestId:', requestId);
            currentRequestId = requestId;
            document.getElementById('returnRequestId').value = requestId;
            document.getElementById('returnComment').value = '';
            document.getElementById('returnModal').classList.add('active');
        }

        function closeReturnModal() {
            document.getElementById('returnModal').classList.remove('active');
            currentRequestId = null;
        }

        document.getElementById('returnForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const requestId = document.getElementById('returnRequestId').value;
            const comment = document.getElementById('returnComment').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø±Ú¯Ø´Øª Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/return`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comment: comment || 'Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯',
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
                    closeReturnModal();
                    await loadDepartmentRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ú¯Ø´Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ú¯Ø´Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });
    </script>
</body>
</html>
