<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .permissions-grid {
            overflow-x: auto;
            margin-top: 20px;
        }

        .permissions-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .permissions-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }

        .permissions-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .permissions-table tr:hover {
            background: #f9fafb;
        }

        .permissions-table .page-name {
            text-align: right;
            font-weight: 500;
            color: #374151;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .role-header {
            writing-mode: horizontal-tb;
            transform: none;
            white-space: nowrap;
        }

        .save-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .btn-save {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .changes-indicator {
            display: inline-block;
            margin-right: 10px;
            padding: 5px 15px;
            background: #fbbf24;
            color: #78350f;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .changes-indicator.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§</h1>
                <p class="page-description">ØªØ¹ÛŒÛŒÙ† Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙØ­Ø§Øª Ù…Ø®ØªÙ„Ù</p>
            </header>

            <div class="content-section">
                <div class="permissions-grid">
                    <table class="permissions-table">
                        <thead>
                            <tr>
                                <th class="page-name">ØµÙØ­Ù‡ / Ù†Ù‚Ø´</th>
                                <th class="role-header">Ù…Ø¯ÛŒØ±</th>
                                <th class="role-header">Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯</th>
                                <th class="role-header">Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                                <th class="role-header">Ú©Ø§Ø±Ø´Ù†Ø§Ø³</th>
                                <th class="role-header">Ø§Ù†Ø¨Ø§Ø± Ø¯Ø§Ø±</th>
                            </tr>
                        </thead>
                        <tbody id="permissionsTableBody">
                            <tr>
                                <td colspan="6" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="save-section">
                    <span class="changes-indicator hidden" id="changesIndicator">
                        ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡
                    </span>
                    <button onclick="savePermissions()" class="btn-save" id="saveButton">
                        ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script src="api-mock.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            initializeMenu();
            await loadPermissions();
        })();

        let permissionsData = [];
        let hasChanges = false;

        const pages = [
            { name: 'dashboard', title: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯' },
            { name: 'tasks', title: 'Ú©Ø§Ø±Ù‡Ø§' },
            { name: 'requests', title: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§' },
            { name: 'products', title: 'Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§' },
            { name: 'users', title: 'Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†' },
            { name: 'departments', title: 'ÙˆØ§Ø­Ø¯Ù‡Ø§' },
            { name: 'permissions', title: 'Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§' },
            { name: 'department-requests', title: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯' },
            { name: 'warehouse-requests', title: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±' },
            { name: 'reports-requests', title: 'Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§' },
            { name: 'reports-departments', title: 'Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯Ù‡Ø§' },
            { name: 'reports-products', title: 'Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­ØµÙˆÙ„Ø§Øª' }
        ];

        const roles = ['Ù…Ø¯ÛŒØ±', 'Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯', 'Ú©Ø§Ø±Ù…Ù†Ø¯', 'Ú©Ø§Ø±Ø´Ù†Ø§Ø³', 'Ø§Ù†Ø¨Ø§Ø± Ø¯Ø§Ø±'];

        async function loadPermissions() {
            try {
                const result = await permissionsAPI.getAll();
                
                if (result.success && result.permissions) {
                    permissionsData = result.permissions;
                    displayPermissions();
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:', result);
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function displayPermissions() {
            const tbody = document.getElementById('permissionsTableBody');
            
            tbody.innerHTML = pages.map(page => {
                return `
                    <tr>
                        <td class="page-name">${page.title}</td>
                        ${roles.map(role => {
                            const permission = permissionsData.find(p => 
                                p.role_name === role && p.page_name === page.name
                            );
                            const isChecked = permission ? permission.has_access : false;
                            
                            return `
                                <td>
                                    <input 
                                        type="checkbox" 
                                        class="permission-checkbox"
                                        data-role="${role}"
                                        data-page="${page.name}"
                                        ${isChecked ? 'checked' : ''}
                                        onchange="handlePermissionChange(this)"
                                    />
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }

        function handlePermissionChange(checkbox) {
            const role = checkbox.dataset.role;
            const page = checkbox.dataset.page;
            const hasAccess = checkbox.checked;

            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
            const permission = permissionsData.find(p => 
                p.role_name === role && p.page_name === page
            );
            
            if (permission) {
                permission.has_access = hasAccess ? 1 : 0;
            }

            // Ù†Ù…Ø§ÛŒØ´ Ø§Ù†Ø¯ÛŒÚ©ÛŒØªÙˆØ± ØªØºÛŒÛŒØ±Ø§Øª
            hasChanges = true;
            document.getElementById('changesIndicator').classList.remove('hidden');
        }

        async function savePermissions() {
            if (!hasChanges) {
                alert('Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }

            const saveButton = document.getElementById('saveButton');
            saveButton.disabled = true;
            saveButton.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

            try {
                const result = await permissionsAPI.bulkUpdate(permissionsData);
                
                if (result.success) {
                    alert('âœ“ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯');
                    hasChanges = false;
                    document.getElementById('changesIndicator').classList.add('hidden');
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ Ù…Ø­Ù„ÛŒ ØªØ§ ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÛŒØ¯ Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯
                    try {
                        localStorage.removeItem('permissionsMap');
                        // Ø§Ú¯Ø± Ù†Ù‚Ø´ ÙØ¹Ù„ÛŒ ØªØ­Øª ØªØ§Ø«ÛŒØ± Ø§Ø³ØªØŒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù…Ù†ÙˆÙ‡Ø§ Ø±Ø§ Ø¨Ø±ÙˆØ² Ú©Ù†
                        if (typeof checkPagePermissions === 'function') {
                            await checkPagePermissions();
                            initializeMenu();
                        }
                    } catch (e) {
                        console.error('Error refreshing permissions cache:', e);
                    }
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
            }
        }
    </script>
</body>
</html>

