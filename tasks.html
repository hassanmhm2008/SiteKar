<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù‡Ø§ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="jalali-calendar.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item active">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù‡Ø§</h1>
                <div class="header-actions">
                    <button onclick="openTaskModal()" class="btn btn-primary">+ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</button>
                </div>
            </header>

            <div class="content-section">
                <div class="filters">
                    <select id="statusFilter" onchange="filterTasks()">
                        <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="Ø¬Ø¯ÛŒØ¯">Ø¬Ø¯ÛŒØ¯</option>
                        <option value="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                        <option value="ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                        <option value="Ù„ØºÙˆ Ø´Ø¯Ù‡">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                    </select>

                    <select id="priorityFilter" onchange="filterTasks()">
                        <option value="">Ù‡Ù…Ù‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="Ø¨Ø­Ø±Ø§Ù†ÛŒ">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                        <option value="Ø¨Ø§Ù„Ø§">Ø¨Ø§Ù„Ø§</option>
                        <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                        <option value="Ù¾Ø§ÛŒÛŒÙ†">Ù¾Ø§ÛŒÛŒÙ†</option>
                    </select>

                    <select id="userFilter" onchange="filterTasks()">
                        <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                                <th>Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th>Ø§ÙˆÙ„ÙˆÛŒØª</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>Ù…Ø­ÙˆÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡</th>
                                <th>Ù…Ù‡Ù„Øª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <tr>
                                <td colspan="8" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø± -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <button onclick="closeTaskModal()" class="modal-close">&times;</button>
            </div>
            <form id="taskForm" class="modal-form">
                <input type="hidden" id="taskId">
                
                <div class="form-group">
                    <label for="title">Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø± *</label>
                    <input type="text" id="title" required>
                </div>

                <div class="form-group">
                    <label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                    <textarea id="description" rows="4"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Ø§ÙˆÙ„ÙˆÛŒØª *</label>
                        <select id="priority" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            <option value="Ø¨Ø­Ø±Ø§Ù†ÛŒ">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                            <option value="Ø¨Ø§Ù„Ø§">Ø¨Ø§Ù„Ø§</option>
                            <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ù¾Ø§ÛŒÛŒÙ†">Ù¾Ø§ÛŒÛŒÙ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">ÙˆØ¶Ø¹ÛŒØª *</label>
                        <select id="status" required>
                            <option value="Ø¬Ø¯ÛŒØ¯">Ø¬Ø¯ÛŒØ¯</option>
                            <option value="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                            <option value="ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="Ù„ØºÙˆ Ø´Ø¯Ù‡">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="assignedTo">Ù…Ø­ÙˆÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡ *</label>
                        <select id="assignedTo" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="deadline">Ù…Ù‡Ù„Øª Ø§Ù†Ø¬Ø§Ù…</label>
                        <input type="text" id="deadline" placeholder="1404/08/14" dir="ltr">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button type="button" onclick="closeTaskModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="app.js"></script>
    <script src="jalali-calendar.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkPagePermissions();
            initializeMenu();
        })();
        
        loadTasks();
        loadUserFilters();

        let editingTaskId = null;

        function loadTasks() {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const tbody = document.getElementById('tasksTableBody');

            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                return;
            }

            displayTasks(tasks, users);
        }

        function displayTasks(tasks, users = null) {
            if (!users) {
                users = JSON.parse(localStorage.getItem('users') || '[]');
            }

            const tbody = document.getElementById('tasksTableBody');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(task => {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                // Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ ØªØ§Ø±ÛŒØ® Ù…Ù‡Ù„Øª: Ø¯Ø± ØµÙˆØ±Øª Ø´Ù…Ø³ÛŒ Ø¨ÙˆØ¯Ù†ØŒ Ù‡Ù…Ø§Ù† Ù…Ù‚Ø¯Ø§Ø± Ø´Ù…Ø³ÛŒ Ø¨Ø§ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ
                let deadline = '-';
                if (task.deadline) {
                    try {
                        const parsed = (typeof parseJalaliInputDate === 'function') ? parseJalaliInputDate(task.deadline) : null;
                        if (parsed) {
                            const y = parsed.jy;
                            const m = String(parsed.jm).padStart(2, '0');
                            const d = String(parsed.jd).padStart(2, '0');
                            deadline = toPersianNumber ? toPersianNumber(`${y}/${m}/${d}`) : `${y}/${m}/${d}`;
                        } else {
                            const dt = new Date(task.deadline);
                            if (!isNaN(dt)) {
                                deadline = dt.toLocaleDateString('fa-IR');
                            } else {
                                deadline = toPersianNumber ? toPersianNumber(task.deadline) : task.deadline;
                            }
                        }
                    } catch (e) {
                        deadline = toPersianNumber ? toPersianNumber(task.deadline) : task.deadline;
                    }
                }
                
                return `
                    <tr>
                        <td>${toPersianNumber(task.id)}</td>
                        <td>${task.title}</td>
                        <td>${task.description || '-'}</td>
                        <td><span class="badge badge-priority-${task.priority}">${task.priority}</span></td>
                        <td><span class="badge badge-${getStatusClass(task.status)}">${task.status}</span></td>
                        <td>${assignedUser ? assignedUser.fullName : '-'}</td>
                        <td>${deadline}</td>
                        <td>
                            <button onclick="editTask(${task.id})" class="btn-icon" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                            <button onclick="deleteTask(${task.id})" class="btn-icon" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadUserFilters() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userFilter = document.getElementById('userFilter');
            
            userFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>' +
                users.map(user => `<option value="${user.id}">${user.fullName}</option>`).join('');
        }

        function filterTasks() {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const userFilter = document.getElementById('userFilter').value;

            const filteredTasks = tasks.filter(task => {
                if (statusFilter && task.status !== statusFilter) return false;
                if (priorityFilter && task.priority !== priorityFilter) return false;
                if (userFilter && task.assignedTo !== parseInt(userFilter)) return false;
                return true;
            });

            displayTasks(filteredTasks);
        }

        function openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const modalTitle = document.getElementById('modalTitle');
            
            form.reset();
            editingTaskId = taskId;

            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            loadUsersForAssignment();

            if (taskId) {
                modalTitle.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±';
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('title').value = task.title;
                    document.getElementById('description').value = task.description || '';
                    document.getElementById('priority').value = task.priority;
                    document.getElementById('status').value = task.status;
                    document.getElementById('assignedTo').value = task.assignedTo;
                    document.getElementById('deadline').value = task.deadline || '';
                }
            } else {
                modalTitle.textContent = 'Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯';
                document.getElementById('status').value = 'Ø¬Ø¯ÛŒØ¯';
            }

            modal.style.display = 'flex';
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù† modal
            setTimeout(() => {
                initJalaliDatePicker('deadline', false);
            }, 100);
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }

        function loadUsersForAssignment() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const assignedToSelect = document.getElementById('assignedTo');
            
            assignedToSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</option>' +
                users.map(user => `<option value="${user.id}">${user.fullName} (${user.role})</option>`).join('');
        }

        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                priority: document.getElementById('priority').value,
                status: document.getElementById('status').value,
                assignedTo: parseInt(document.getElementById('assignedTo').value),
                deadline: document.getElementById('deadline').value,
                createdBy: currentUser.id
            };

            if (editingTaskId) {
                // ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±
                const index = tasks.findIndex(t => t.id === editingTaskId);
                tasks[index] = { ...tasks[index], ...formData, updatedAt: new Date().toISOString() };
            } else {
                // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
                const newTask = {
                    id: tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1,
                    ...formData,
                    createdAt: new Date().toISOString()
                };
                tasks.push(newTask);
            }

            localStorage.setItem('tasks', JSON.stringify(tasks));
            closeTaskModal();
            loadTasks();
            alert(editingTaskId ? 'Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
        });

        function editTask(taskId) {
            openTaskModal(taskId);
        }

        function deleteTask(taskId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const filteredTasks = tasks.filter(t => t.id !== taskId);
                localStorage.setItem('tasks', JSON.stringify(filteredTasks));
                loadTasks();
                alert('Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            }
        }

        function getStatusClass(status) {
            const statusMap = {
                'Ø¬Ø¯ÛŒØ¯': 'new',
                'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…': 'progress',
                'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡': 'completed',
                'Ù„ØºÙˆ Ø´Ø¯Ù‡': 'cancelled'
            };
            return statusMap[status] || 'new';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('taskModal');
            if (event.target === modal) {
                closeTaskModal();
            }
        }
    </script>
</body>
</html>