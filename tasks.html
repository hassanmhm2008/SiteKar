<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù‡Ø§ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="jalali-calendar.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item active">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù‡Ø§</h1>
                <div class="header-actions">
                    <button onclick="openTaskModal()" class="btn btn-primary">+ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</button>
                </div>
            </header>

            <div class="content-section">
                <div class="filters">
                    <select id="statusFilter" onchange="filterTasks()">
                        <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="Ø¬Ø¯ÛŒØ¯">Ø¬Ø¯ÛŒØ¯</option>
                        <option value="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                        <option value="ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                        <option value="Ù„ØºÙˆ Ø´Ø¯Ù‡">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                    </select>

                    <select id="priorityFilter" onchange="filterTasks()">
                        <option value="">Ù‡Ù…Ù‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="Ø¨Ø­Ø±Ø§Ù†ÛŒ">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                        <option value="Ø¨Ø§Ù„Ø§">Ø¨Ø§Ù„Ø§</option>
                        <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                        <option value="Ù¾Ø§ÛŒÛŒÙ†">Ù¾Ø§ÛŒÛŒÙ†</option>
                    </select>

                    <select id="userFilter" onchange="filterTasks()">
                        <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                                <th>Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th>Ø§ÙˆÙ„ÙˆÛŒØª</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>Ù…Ø­ÙˆÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡</th>
                                <th>Ù…Ù‡Ù„Øª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <tr>
                                <td colspan="8" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø± -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <button onclick="closeTaskModal()" class="modal-close">&times;</button>
            </div>
            <form id="taskForm" class="modal-form">
                <input type="hidden" id="taskId">
                
                <div class="form-group">
                    <label for="title">Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø± *</label>
                    <input type="text" id="title" required>
                </div>

                <div class="form-group">
                    <label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                    <textarea id="description" rows="4"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Ø§ÙˆÙ„ÙˆÛŒØª *</label>
                        <select id="priority" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            <option value="Ø¨Ø­Ø±Ø§Ù†ÛŒ">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                            <option value="Ø¨Ø§Ù„Ø§">Ø¨Ø§Ù„Ø§</option>
                            <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ù¾Ø§ÛŒÛŒÙ†">Ù¾Ø§ÛŒÛŒÙ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">ÙˆØ¶Ø¹ÛŒØª *</label>
                        <select id="status" required>
                            <option value="Ø¬Ø¯ÛŒØ¯">Ø¬Ø¯ÛŒØ¯</option>
                            <option value="Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                            <option value="ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="Ù„ØºÙˆ Ø´Ø¯Ù‡">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="assignedTo">Ù…Ø­ÙˆÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡ *</label>
                        <select id="assignedTo" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="deadline">Ù…Ù‡Ù„Øª Ø§Ù†Ø¬Ø§Ù…</label>
                        <input type="text" id="deadline" placeholder="1404/08/14" dir="ltr">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button type="button" onclick="closeTaskModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="api-mock.js"></script>
    <script src="app.js"></script>
    <script src="jalali-calendar.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkPagePermissions();
            initializeMenu();
        })();
        
        loadTasks();
        loadUserFilters();

        let editingTaskId = null;

        async function loadTasks() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const tbody = document.getElementById('tasksTableBody');

            if (!currentUser) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</td></tr>';
                return;
            }

            try {
                // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ù‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
                const result = await tasksAPI.getAll();
                
                if (!result.success) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ù‡Ø§</td></tr>';
                    return;
                }

                const tasks = result.data || result.tasks || [];
                
                // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù…â€ŒÙ‡Ø§
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.length === 0) {
                    const usersResult = await usersAPI.getAll();
                    if (usersResult.success && usersResult.users) {
                        users = usersResult.users;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                }

                // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
                let visibleTasks = [];
                
                if (currentUser.role === 'Ù…Ø¯ÛŒØ±') {
                    // Ù…Ø¯ÛŒØ± Ù‡Ù…Ù‡ Ú©Ø§Ø±Ù‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯
                    visibleTasks = tasks;
                } else {
                    // Ø³Ø§ÛŒØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙÙ‚Ø· Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø­ÙˆÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø®ÙˆØ¯Ø´Ø§Ù† ÛŒØ§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø®ÙˆØ¯Ø´Ø§Ù† Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯
                    const currentUserId = parseInt(currentUser.id || currentUser.user_id);
                    
                    visibleTasks = tasks.filter(task => {
                        const assignedTo = parseInt(task.assignedTo || task.assigned_to);
                        const createdBy = parseInt(task.createdBy || task.created_by);
                        return assignedTo === currentUserId || createdBy === currentUserId;
                    });
                }

                if (visibleTasks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                    return;
                }

                displayTasks(visibleTasks, users);
            } catch (error) {
                console.error('Error loading tasks:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ù‡Ø§. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</td></tr>';
            }
        }

        function displayTasks(tasks, users = null) {
            if (!users) {
                users = JSON.parse(localStorage.getItem('users') || '[]');
            }

            const tbody = document.getElementById('tasksTableBody');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(task => {
                // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª fullName Ùˆ full_name
                const assignedUser = users.find(u => u.id === task.assignedTo || u.id === task.assigned_to);
                const assignedName = assignedUser ? (assignedUser.fullName || assignedUser.full_name || assignedUser.username || '-') : '-';
                // Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ ØªØ§Ø±ÛŒØ® Ù…Ù‡Ù„Øª: Ø¯Ø± ØµÙˆØ±Øª Ø´Ù…Ø³ÛŒ Ø¨ÙˆØ¯Ù†ØŒ Ù‡Ù…Ø§Ù† Ù…Ù‚Ø¯Ø§Ø± Ø´Ù…Ø³ÛŒ Ø¨Ø§ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ
                let deadline = '-';
                if (task.deadline) {
                    try {
                        const parsed = (typeof parseJalaliInputDate === 'function') ? parseJalaliInputDate(task.deadline) : null;
                        if (parsed) {
                            const y = parsed.jy;
                            const m = String(parsed.jm).padStart(2, '0');
                            const d = String(parsed.jd).padStart(2, '0');
                            deadline = toPersianNumber ? toPersianNumber(`${y}/${m}/${d}`) : `${y}/${m}/${d}`;
                        } else {
                            const dt = new Date(task.deadline);
                            if (!isNaN(dt)) {
                                deadline = dt.toLocaleDateString('fa-IR');
                            } else {
                                deadline = toPersianNumber ? toPersianNumber(task.deadline) : task.deadline;
                            }
                        }
                    } catch (e) {
                        deadline = toPersianNumber ? toPersianNumber(task.deadline) : task.deadline;
                    }
                }
                //ÙØ³Ù
                return `
                    <tr>
                        <td>${toPersianNumber(task.id)}</td>
                        <td>${task.title}</td>
                        <td>${task.description || '-'}</td>
                        <td><span class="badge badge-priority-${task.priority}">${task.priority}</span></td>
                        <td><span class="badge badge-${getStatusClass(task.status)}">${task.status}</span></td>
                        <td>${assignedName}</td>
                        <td>${deadline}</td>
                        <td>
                            <button onclick="editTask(${task.id})" class="btn-icon" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                            <button onclick="deleteTask(${task.id})" class="btn-icon" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadUserFilters() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userFilter = document.getElementById('userFilter');
            
            // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª
            userFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>' +
                users.map(user => `<option value="${user.id}">${user.fullName || user.full_name || user.username}</option>`).join('');
        }

        async function filterTasks() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const userFilter = document.getElementById('userFilter').value;

            if (!currentUser) {
                displayTasks([]);
                return;
            }

            try {
                // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ù‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
                const result = await tasksAPI.getAll();
                
                if (!result.success) {
                    displayTasks([]);
                    return;
                }

                const tasks = result.data || result.tasks || [];

                // Ø§Ø¨ØªØ¯Ø§ ÙÛŒÙ„ØªØ± Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
                let visibleTasks = [];
                const currentUserId = parseInt(currentUser.id || currentUser.user_id);
                
                if (currentUser.role === 'Ù…Ø¯ÛŒØ±') {
                    visibleTasks = tasks;
                } else {
                    visibleTasks = tasks.filter(task => {
                        const assignedTo = parseInt(task.assignedTo || task.assigned_to);
                        const createdBy = parseInt(task.createdBy || task.created_by);
                        return assignedTo === currentUserId || createdBy === currentUserId;
                    });
                }

                // Ø³Ù¾Ø³ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                const filteredTasks = visibleTasks.filter(task => {
                    if (statusFilter && task.status !== statusFilter) return false;
                    if (priorityFilter && task.priority !== priorityFilter) return false;
                    if (userFilter) {
                        const taskAssignedTo = parseInt(task.assignedTo || task.assigned_to);
                        if (taskAssignedTo !== parseInt(userFilter)) return false;
                    }
                    return true;
                });

                displayTasks(filteredTasks);
            } catch (error) {
                console.error('Error filtering tasks:', error);
                displayTasks([]);
            }
        }

        async function openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const modalTitle = document.getElementById('modalTitle');
            
            form.reset();
            editingTaskId = taskId;

            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (async)
            await loadUsersForAssignment();

            if (taskId) {
                modalTitle.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±';
                
                try {
                    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø± Ø§Ø² Ø³Ø±ÙˆØ±
                    const result = await tasksAPI.getAll();
                    if (result.success) {
                        const tasks = result.data || result.tasks || [];
                        const task = tasks.find(t => t.id === taskId);
                        
                        if (task) {
                            document.getElementById('taskId').value = task.id;
                            document.getElementById('title').value = task.title;
                            document.getElementById('description').value = task.description || '';
                            document.getElementById('priority').value = task.priority;
                            document.getElementById('status').value = task.status;
                            document.getElementById('assignedTo').value = task.assignedTo || task.assigned_to;
                            document.getElementById('deadline').value = task.deadline || '';
                        }
                    }
                } catch (error) {
                    console.error('Error loading task:', error);
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±');
                }
            } else {
                modalTitle.textContent = 'Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯';
                document.getElementById('status').value = 'Ø¬Ø¯ÛŒØ¯';
            }

            modal.style.display = 'flex';
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù† modal
            setTimeout(() => {
                initJalaliDatePicker('deadline', false);
            }, 100);
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }

        async function loadUsersForAssignment() {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentUserRaw = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const assignedToSelect = document.getElementById('assignedTo');

            // Ø§Ú¯Ø± users Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ø§Ø² API Ø¨Ú¯ÛŒØ±ÛŒÙ…
            if (users.length === 0) {
                try {
                    const result = await usersAPI.getAll();
                    if (result.success && result.users) {
                        users = result.users;
                        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø± Ø¨Ø¹Ø¯
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                } catch (error) {
                    console.error('Failed to load users from API:', error);
                }
            }

            if (!currentUserRaw) {
                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ØŒ Ù‡Ù…Ù‡ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                assignedToSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</option>' +
                    users.map(user => `<option value="${user.id}">${user.fullName || user.full_name || user.username} (${user.role})</option>`).join('');
                return;
            }

            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ú©Ø§Ù…Ù„ Ø§Ø² Ù„ÛŒØ³Øª users Ø¨Ø± Ø§Ø³Ø§Ø³ idØŒ user_idØŒ ÛŒØ§ username
            let actualCurrentUser = null;
            
            // Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§ id
            if (currentUserRaw.id) {
                actualCurrentUser = users.find(u => u.id === currentUserRaw.id);
            }
            // Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§ user_id (Ø§Ø² API)
            if (!actualCurrentUser && currentUserRaw.user_id) {
                actualCurrentUser = users.find(u => u.id === currentUserRaw.user_id || u.user_id === currentUserRaw.user_id);
            }
            // Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§ username
            if (!actualCurrentUser && currentUserRaw.username) {
                actualCurrentUser = users.find(u => u.username === currentUserRaw.username);
            }
            
            // Ø§Ú¯Ø± Ø¯Ø± users Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ø®ÙˆØ¯ currentUser Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (Ø¨Ø§ normalize Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§)
            if (!actualCurrentUser) {
                actualCurrentUser = {
                    id: currentUserRaw.id || currentUserRaw.user_id,
                    username: currentUserRaw.username,
                    fullName: currentUserRaw.fullName || currentUserRaw.full_name || currentUserRaw.username,
                    role: currentUserRaw.role,
                    supervisor: currentUserRaw.supervisor || currentUserRaw.supervisor_id,
                    department_id: currentUserRaw.department_id || currentUserRaw.departmentId
                };
                // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² id Ù†Ø¯Ø§Ø±Ù‡ØŒ Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒÙ… Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÛŒÙ…
                if (!actualCurrentUser.id) {
                    console.error('Cannot determine user ID from currentUser:', currentUserRaw);
                    assignedToSelect.innerHTML = '<option value="">Ø®Ø·Ø§: Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯</option>';
                    return;
                }
            }

            // normalize Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ø­Ù…Ø§ÛŒØª Ø§Ø² Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª snake_case Ùˆ camelCase)
            const normalizeUser = (u) => ({
                id: u.id || u.user_id,
                username: u.username,
                fullName: u.fullName || u.full_name || u.username,
                role: u.role,
                supervisor: u.supervisor || u.supervisor_id,
                department_id: u.department_id || u.departmentId
            });

            const currentUser = normalizeUser(actualCurrentUser);
            const normalizedUsers = users.map(normalizeUser);

            const isLeaderRole = role => role && ['Ø±Ø¦ÛŒØ³','Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯'].includes(role);

            let allowedUsers = [];
            
            if (currentUser.role === 'Ù…Ø¯ÛŒØ±') {
                // Ù…Ø¯ÛŒØ± Ù‡Ù…Ù‡ Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯
                allowedUsers = normalizedUsers.slice();
            } else if (isLeaderRole(currentUser.role)) {
                // Ø±Ø¦ÛŒØ³: Ø§Ø¹Ø¶Ø§ÛŒ ÙˆØ§Ø­Ø¯ Ø®ÙˆØ¯Ø´ + Ù‡Ù…Ù‡Ù” Ø±Ø¤Ø³Ø§ÛŒ Ø¯ÛŒÚ¯Ø± + Ø®ÙˆØ¯Ø´
                
                // Ø±ÙˆØ´ Ø§ÙˆÙ„: Ø§Ú¯Ø± supervisor Ø¯Ø§Ø´ØªÙ†Ø¯ (fallback)
                let myGroupMembers = normalizedUsers.filter(u => u.supervisor === currentUser.id);
                
                // Ø±ÙˆØ´ Ø¯ÙˆÙ…: Ø§Ú¯Ø± supervisor Ù†Ø¯Ø§Ø´ØªÙ†Ø¯ØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ department
                if (myGroupMembers.length === 0 && currentUser.department_id) {
                    myGroupMembers = normalizedUsers.filter(u => 
                        u.department_id === currentUser.department_id && u.id !== currentUser.id
                    );
                }
                
                const allLeaders = normalizedUsers.filter(u => isLeaderRole(u.role));
                
                const set = new Map();
                myGroupMembers.forEach(u => set.set(u.id, u));
                allLeaders.forEach(u => set.set(u.id, u));
                set.set(currentUser.id, currentUser);
                
                allowedUsers = Array.from(set.values());
            } else {
                // Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ: Ù‡Ù…Ù‡ Ø§Ø¹Ø¶Ø§ÛŒ ÙˆØ§Ø­Ø¯ + Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯
                
                // Ø±ÙˆØ´ Ø§ÙˆÙ„: Ø§Ú¯Ø± supervisor Ø¯Ø§Ø´Øª
                if (currentUser.supervisor) {
                    const leader = normalizedUsers.find(u => u.id === currentUser.supervisor);
                    
                    if (leader && isLeaderRole(leader.role)) {
                        const groupMembers = normalizedUsers.filter(u => u.supervisor === leader.id);
                        
                        const set = new Map();
                        set.set(leader.id, leader);
                        groupMembers.forEach(u => set.set(u.id, u));
                        set.set(currentUser.id, currentUser);
                        
                        allowedUsers = Array.from(set.values());
                    } else {
                        allowedUsers = [];
                    }
                }
                
                // Ø±ÙˆØ´ Ø¯ÙˆÙ…: Ø§Ú¯Ø± supervisor Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ department
                if (allowedUsers.length === 0 && currentUser.department_id) {
                    const deptMembers = normalizedUsers.filter(u => u.department_id === currentUser.department_id);
                    
                    const set = new Map();
                    deptMembers.forEach(u => set.set(u.id, u));
                    
                    allowedUsers = Array.from(set.values());
                } else if (allowedUsers.length === 0) {
                    allowedUsers = [currentUser];
                }
            }

            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: Ø§ÙˆÙ„ Ø±Ø¤Ø³Ø§ØŒ Ø¨Ø¹Ø¯ Ø¨Ù‚ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…
            const roleOrder = u => (isLeaderRole(u.role) ? 0 : 1);
            allowedUsers.sort((a,b) => {
                const orderDiff = roleOrder(a) - roleOrder(b);
                if (orderDiff !== 0) return orderDiff;
                return (a.fullName || '').localeCompare(b.fullName || '', 'fa');
            });

            assignedToSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</option>' +
                allowedUsers.map(user => `<option value="${user.id}">${user.fullName} (${user.role})</option>`).join('');
        }

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                priority: document.getElementById('priority').value,
                status: document.getElementById('status').value,
                assigned_to: parseInt(document.getElementById('assignedTo').value),
                deadline: document.getElementById('deadline').value,
                created_by: parseInt(currentUser.id || currentUser.user_id),
                department_id: currentUser.department_id || null
            };

            console.log('Submitting task:', formData);
            console.log('Edit mode:', editingTaskId ? 'Edit (id=' + editingTaskId + ')' : 'Create');

            try {
                if (editingTaskId) {
                    // ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±
                    console.log('Calling tasksAPI.update...');
                    const result = await tasksAPI.update(editingTaskId, formData);
                    console.log('Update result:', result);
                    
                    if (result.success) {
                        closeTaskModal();
                        await loadTasks();
                        alert('Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
                    } else {
                        alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±: ' + (result.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
                    }
                } else {
                    // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
                    console.log('Calling tasksAPI.create...');
                    const result = await tasksAPI.create(formData);
                    console.log('Create result:', result);
                    
                    if (result.success) {
                        closeTaskModal();
                        await loadTasks();
                        alert('Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                    } else {
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±: ' + (result.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
                    }
                }
            } catch (error) {
                console.error('Error saving task:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±: ' + error.message);
            }
        });

        function editTask(taskId) {
            openTaskModal(taskId);
        }

        async function deleteTask(taskId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await tasksAPI.delete(taskId);
                    if (result.success) {
                        await loadTasks();
                        alert('Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    } else {
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                }
            }
        }

        function getStatusClass(status) {
            const statusMap = {
                'Ø¬Ø¯ÛŒØ¯': 'new',
                'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…': 'progress',
                'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡': 'completed',
                'Ù„ØºÙˆ Ø´Ø¯Ù‡': 'cancelled'
            };
            return statusMap[status] || 'new';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('taskModal');
            if (event.target === modal) {
                closeTaskModal();
            }
        }
    </script>
</body>
</html>
