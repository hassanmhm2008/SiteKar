<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="jalali-calendar.css">
    
    <style>
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            font-family: 'Vazir', Tahoma, sans-serif;
        }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .report-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            width: 220px;
            min-width: 220px;
            position: relative;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-family: 'Vazir', Tahoma, sans-serif;
        }
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Vazir', Tahoma, sans-serif;
        }
        .filter-group input[type="text"] {
            padding: 10px 35px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>');
            background-repeat: no-repeat;
            background-position: 8px center;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            direction: ltr;
            font-family: 'Vazir', Tahoma, sans-serif;
        }
        .filter-group input[type="text"]:focus {
            outline: 2px solid #007bff;
            border-color: #007bff;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item active">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h1>
            </header>

            <div class="content-section">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('requests')">Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</button>
                    <button class="tab" onclick="switchTab('departments')">Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ§Ø­Ø¯</button>
                    <button class="tab" onclick="switchTab('products')">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­ØµÙˆÙ„Ø§Øª ØªØ¬Ù…ÛŒØ¹ÛŒ</button>
                </div>

                <!-- Tab 1: Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ -->
                <div id="tab-requests" class="tab-content active">
                    <div class="report-filters">
                        <h3>ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>ÙˆØ¶Ø¹ÛŒØª:</label>
                                <select id="status1">
                                    <option value="">Ù‡Ù…Ù‡</option>
                                    <option value="Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡">Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡</option>
                                    <option value="Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</option>
                                    <option value="ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</option>
                                    <option value="Ø±Ø¯ Ø´Ø¯Ù‡">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                                    <option value="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                                    <option value="ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                                    <option value="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label>
                                <input type="text" id="fromDate1" placeholder="1403/01/01" dir="ltr">
                            </div>
                            <div class="filter-group">
                                <label>ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label>
                                <input type="text" id="toDate1" placeholder="1403/12/29" dir="ltr">
                            </div>
                            <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
                                <button onclick="loadRequestsReport()" class="btn btn-primary">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
                                <button onclick="downloadReport('requests')" class="btn btn-success">Ø¯Ø±ÛŒØ§ÙØª PDF</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø±Ø¯ÛŒÙ</th>
                                    <th>Ø´Ù…Ø§Ø±Ù‡</th>
                                    <th>Ú©Ø§Ø±Ø¨Ø±</th>
                                    <th>ÙˆØ§Ø­Ø¯</th>
                                    <th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ù„Ø§Ù…</th>
                                    <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                    <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                                </tr>
                            </thead>
                            <tbody id="requestsReportBody">
                                <tr><td colspan="7" class="empty-state">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 2: Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ§Ø­Ø¯ -->
                <div id="tab-departments" class="tab-content">
                    <div class="report-filters">
                        <h3>ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>ÙˆØ¶Ø¹ÛŒØª:</label>
                                <select id="status2">
                                    <option value="">Ù‡Ù…Ù‡</option>
                                    <option value="Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡">Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡</option>
                                    <option value="Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</option>
                                    <option value="ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</option>
                                    <option value="Ø±Ø¯ Ø´Ø¯Ù‡">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                                    <option value="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                                    <option value="ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                                    <option value="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label>
                                <input type="text" id="fromDate2" placeholder="1403/01/01" dir="ltr">
                            </div>
                            <div class="filter-group">
                                <label>ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label>
                                <input type="text" id="toDate2" placeholder="1403/12/29" dir="ltr">
                            </div>
                            <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
                                <button onclick="loadDepartmentsReport()" class="btn btn-primary">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
                                <button onclick="downloadReport('departments')" class="btn btn-success">Ø¯Ø±ÛŒØ§ÙØª PDF</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø±Ø¯ÛŒÙ</th>
                                    <th>ÙˆØ§Ø­Ø¯</th>
                                    <th>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</th>
                                    <th>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ù‚Ù„Ø§Ù…</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsReportBody">
                                <tr><td colspan="4" class="empty-state">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 3: Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­ØµÙˆÙ„Ø§Øª ØªØ¬Ù…ÛŒØ¹ÛŒ -->
                <div id="tab-products" class="tab-content">
                    <div class="report-filters">
                        <h3>ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>ÙˆØ¶Ø¹ÛŒØª:</label>
                                <select id="status3">
                                    <option value="">Ù‡Ù…Ù‡</option>
                                    <option value="Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡">Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡</option>
                                    <option value="Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</option>
                                    <option value="ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</option>
                                    <option value="Ø±Ø¯ Ø´Ø¯Ù‡">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                                    <option value="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                                    <option value="ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                                    <option value="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label>
                                <input type="text" id="fromDate3" placeholder="1403/01/01" dir="ltr">
                            </div>
                            <div class="filter-group">
                                <label>ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label>
                                <input type="text" id="toDate3" placeholder="1403/12/29" dir="ltr">
                            </div>
                            <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
                                <button onclick="loadProductsReport()" class="btn btn-primary">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
                                <button onclick="downloadReport('products')" class="btn btn-success">Ø¯Ø±ÛŒØ§ÙØª PDF</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø±Ø¯ÛŒÙ</th>
                                    <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
                                    <th>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„</th>
                                    <th>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</th>
                                </tr>
                            </thead>
                            <tbody id="productsReportBody">
                                <tr><td colspan="4" class="empty-state">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- pdfMake for PDF generation Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙØ§Ø±Ø³ÛŒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <script src="api-mock.js"></script>
    <script src="app.js"></script>
    <script src="jalali-calendar.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        let userPermissions = {};
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            await loadUserReportPermissions();
            initializeMenu();
            initializeTabs();
            initializeDatePickers(); // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ…â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø³ÛŒ
        })();

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        function initializeDatePickers() {
            const dateFields = ['fromDate1', 'toDate1', 'fromDate2', 'toDate2', 'fromDate3', 'toDate3'];
            initJalaliDatePickers(dateFields, true);
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù‡Ø± Ú¯Ø²Ø§Ø±Ø´
        async function loadUserReportPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) return;

            try {
                const result = await permissionsAPI.getByRole(currentUser.role);
                if (result.success && result.permissions) {
                    result.permissions.forEach(p => {
                        if (p.page_name.startsWith('reports-')) {
                            userPermissions[p.page_name] = !!p.has_access;
                        }
                    });
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´:', error);
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ¨â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªØ±Ø³ÛŒ
        function initializeTabs() {
            // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ØªØ¨â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯
            const tabs = [
                { name: 'requests', permission: 'reports-requests', button: document.querySelector('[onclick*="switchTab(\'requests\')"]') },
                { name: 'departments', permission: 'reports-departments', button: document.querySelector('[onclick*="switchTab(\'departments\')"]') },
                { name: 'products', permission: 'reports-products', button: document.querySelector('[onclick*="switchTab(\'products\')"]') }
            ];

            let firstAccessibleTab = null;

            tabs.forEach(tab => {
                if (!userPermissions[tab.permission]) {
                    // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ØªØ¨
                    if (tab.button) tab.button.style.display = 'none';
                    // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ ØªØ¨
                    const content = document.getElementById(`tab-${tab.name}`);
                    if (content) content.style.display = 'none';
                } else if (!firstAccessibleTab) {
                    firstAccessibleTab = tab.name;
                }
            });

            // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯
            if (!firstAccessibleTab) {
                document.querySelector('.tabs').innerHTML = '<p style="text-align:center;padding:20px;">Ø´Ù…Ø§ Ø¨Ù‡ Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            } else {
                // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ† ØªØ¨ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³
                switchTab(firstAccessibleTab);
            }
        }

        function switchTab(tabName) {
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
            const permissionName = `reports-${tabName}`;
            if (!userPermissions[permissionName]) {
                alert('Ø´Ù…Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯');
                return;
            }

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ØªØ¨
            const buttons = document.querySelectorAll('.tab');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(tabName)) {
                    btn.classList.add('active');
                }
            });
        }

        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Ø³Ø§Ø¯Ù‡ - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ)
        // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
        function persianToEnglishDigits(str) {
            if (!str) return str;
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            
            for (let i = 0; i < 10; i++) {
                str = str.replace(new RegExp(persianDigits[i], 'g'), englishDigits[i]);
            }
            return str;
        }

        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
        function persianToGregorian(persianDateStr) {
            if (!persianDateStr) return null;
            
            try {
                // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
                persianDateStr = persianToEnglishDigits(persianDateStr);
                
                console.log('ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ:', persianDateStr);
                
                // Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (ÙØ±Ù…Øª: 1404/08/13)
                const parts = persianDateStr.split('/');
                if (parts.length === 3) {
                    const jy = parseInt(parts[0]);
                    const jm = parseInt(parts[1]);
                    const jd = parseInt(parts[2]);
                    
                    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø§ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…
                    const gDate = jalaliToGregorian(jy, jm, jd);
                    const gregorianDate = `${gDate.gy}-${String(gDate.gm).padStart(2, '0')}-${String(gDate.gd).padStart(2, '0')}`;
                    
                    console.log('ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ:', gregorianDate);
                    return gregorianDate;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:', error);
            }
            
            return null;
        }
        
        // ØªØ¨Ø¯ÛŒÙ„ Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ jalaali-js)
        async function loadRequestsReport() {
            try {
                const status = document.getElementById('status1').value;
                const fromDatePersian = document.getElementById('fromDate1').value;
                const toDatePersian = document.getElementById('toDate1').value;
                
                const fromDate = persianToGregorian(fromDatePersian);
                const toDate = persianToGregorian(toDatePersian);

                console.log('ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´:', { 
                    status, 
                    fromDatePersian, 
                    toDatePersian,
                    fromDate, 
                    toDate 
                });

                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (fromDate) params.append('fromDate', fromDate);
                if (toDate) params.append('toDate', toDate);

                console.log('URL:', `http://localhost:3000/api/reports/requests?${params}`);

                const response = await fetch(`http://localhost:3000/api/reports/requests?${params}`);
                const result = await response.json();

                if (result.success) {
                    displayRequestsReport(result.data);
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function displayRequestsReport(data) {
            const tbody = document.getElementById('requestsReportBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((req, index) => `
                <tr>
                    <td>${toPersianNumber(index + 1)}</td>
                    <td>${toPersianNumber(req.request_number || req.id)}</td>
                    <td>${req.user_name}</td>
                    <td>${req.department_name || '-'}</td>
                    <td>${toPersianNumber(req.total_items || 0)}</td>
                    <td><span class="badge badge-info">${req.status}</span></td>
                    <td>${new Date(req.created_at).toLocaleDateString('fa-IR')}</td>
                </tr>
            `).join('');
        }

        async function loadDepartmentsReport() {
            try {
                const status = document.getElementById('status2').value;
                const fromDatePersian = document.getElementById('fromDate2').value;
                const toDatePersian = document.getElementById('toDate2').value;
                
                const fromDate = persianToGregorian(fromDatePersian);
                const toDate = persianToGregorian(toDatePersian);

                console.log('ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯Ù‡Ø§:', { status, fromDatePersian, toDatePersian, fromDate, toDate });

                const params = new URLSearchParams();
                if (fromDate) params.append('fromDate', fromDate);
                if (toDate) params.append('toDate', toDate);
                if (status) params.append('status', status);

                const response = await fetch(`http://localhost:3000/api/reports/by-department?${params}`);
                const result = await response.json();

                if (result.success) {
                    displayDepartmentsReport(result.data);
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function displayDepartmentsReport(data) {
            const tbody = document.getElementById('departmentsReportBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((dept, index) => `
                <tr>
                    <td>${toPersianNumber(index + 1)}</td>
                    <td>${dept.department_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                    <td>${toPersianNumber(dept.request_count)}</td>
                    <td>${toPersianNumber(dept.total_items)}</td>
                </tr>
            `).join('');
        }

        async function loadProductsReport() {
            try {
                const status = document.getElementById('status3').value;
                const fromDatePersian = document.getElementById('fromDate3').value;
                const toDatePersian = document.getElementById('toDate3').value;
                
                const fromDate = persianToGregorian(fromDatePersian);
                const toDate = persianToGregorian(toDatePersian);

                console.log('ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­ØµÙˆÙ„Ø§Øª:', { status, fromDatePersian, toDatePersian, fromDate, toDate });

                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (fromDate) params.append('fromDate', fromDate);
                if (toDate) params.append('toDate', toDate);

                const response = await fetch(`http://localhost:3000/api/reports/products-aggregate?${params}`);
                const result = await response.json();

                if (result.success) {
                    displayProductsReport(result.data);
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function displayProductsReport(data) {
            const tbody = document.getElementById('productsReportBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((product, index) => `
                <tr>
                    <td>${toPersianNumber(index + 1)}</td>
                    <td>${product.product_name}</td>
                    <td>${toPersianNumber(product.total_quantity)}</td>
                    <td>${toPersianNumber(product.request_count)}</td>
                </tr>
            `).join('');
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª PDF ÛŒØ§ Excel
    async function downloadReport(reportType) {
            let data, reportTitle, headers, rows;
            let statusText = 'Ù‡Ù…Ù‡';
            let fromDatePersianValue = '';
            let toDatePersianValue = '';
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´
            if (reportType === 'requests') {
                const status = document.getElementById('status1').value;
                const fromDatePersian = document.getElementById('fromDate1').value;
                const toDatePersian = document.getElementById('toDate1').value;
                const fromDate = persianToGregorian(fromDatePersian);
                const toDate = persianToGregorian(toDatePersian);
                
                let url = `${API_BASE_URL}/reports/requests?`;
                if (fromDate) url += `fromDate=${fromDate}&`;
                if (toDate) url += `toDate=${toDate}&`;
                if (status) url += `status=${status}`;
                
                const response = await fetch(url);
                const result = await response.json();
                data = result.data || result;
                
                reportTitle = 'Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§';
                statusText = status || 'Ù‡Ù…Ù‡';
                fromDatePersianValue = fromDatePersian;
                toDatePersianValue = toDatePersian;
                headers = ['Ø±Ø¯ÛŒÙ', 'Ø´Ù…Ø§Ø±Ù‡', 'Ú©Ø§Ø±Ø¨Ø±', 'ÙˆØ§Ø­Ø¯', 'ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ù„Ø§Ù…', 'ÙˆØ¶Ø¹ÛŒØª', 'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯'];
                rows = data.map((item, index) => {
                    const date = new Date(item.created_at);
                    const jDate = gregorianToJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    const persianDate = `${jDate.jy}/${jDate.jm}/${jDate.jd}`;
                    return [
                        toPersianDigits(index + 1),
                        toPersianDigits(item.request_number || item.id),
                        item.user_name,
                        item.department_name,
                        toPersianDigits(item.item_count),
                        item.status,
                        persianDate
                    ];
                });
                
            } else if (reportType === 'departments') {
                const status = document.getElementById('status2').value;
                const fromDatePersian = document.getElementById('fromDate2').value;
                const toDatePersian = document.getElementById('toDate2').value;
                const fromDate = persianToGregorian(fromDatePersian);
                const toDate = persianToGregorian(toDatePersian);
                
                let url = `${API_BASE_URL}/reports/by-department?`;
                if (fromDate) url += `fromDate=${fromDate}&`;
                if (toDate) url += `toDate=${toDate}&`;
                if (status) url += `status=${status}`;
                
                const response = await fetch(url);
                const result = await response.json();
                data = result.data || result;
                
                reportTitle = 'Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ§Ø­Ø¯';
                statusText = status || 'Ù‡Ù…Ù‡';
                fromDatePersianValue = fromDatePersian;
                toDatePersianValue = toDatePersian;
                headers = ['Ø±Ø¯ÛŒÙ', 'Ù†Ø§Ù… ÙˆØ§Ø­Ø¯', 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ù‚Ù„Ø§Ù…'];
                rows = data.map((item, index) => [
                    toPersianDigits(index + 1),
                    item.department_name,
                    toPersianDigits(item.request_count),
                    toPersianDigits(item.total_items)
                ]);
                
            } else if (reportType === 'products') {
                const status = document.getElementById('status3').value;
                const fromDatePersian = document.getElementById('fromDate3').value;
                const toDatePersian = document.getElementById('toDate3').value;
                const fromDate = persianToGregorian(fromDatePersian);
                const toDate = persianToGregorian(toDatePersian);
                
                let url = `${API_BASE_URL}/reports/products-aggregate?`;
                if (fromDate) url += `fromDate=${fromDate}&`;
                if (toDate) url += `toDate=${toDate}&`;
                if (status) url += `status=${status}`;
                
                const response = await fetch(url);
                const result = await response.json();
                data = result.data || result;
                
                reportTitle = 'Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­ØµÙˆÙ„Ø§Øª ØªØ¬Ù…ÛŒØ¹ÛŒ';
                statusText = status || 'Ù‡Ù…Ù‡';
                fromDatePersianValue = fromDatePersian;
                toDatePersianValue = toDatePersian;
                headers = ['Ø´Ù…Ø§Ø±Ù‡', 'Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„', 'Ù…Ø¬Ù…ÙˆØ¹ ØªØ¹Ø¯Ø§Ø¯', 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§'];
                rows = data.map((item, index) => [
                    toPersianDigits(index + 1),
                    item.product_name,
                    toPersianDigits(item.total_quantity),
                    toPersianDigits(item.request_count)
                ]);
            }
            
            const fromDisplay = toPersianDigits(fromDatePersianValue || '-');
            const toDisplay = toPersianDigits(toDatePersianValue || '-');
            const cleanTitle = reportTitle.replace(/^Ú¯Ø²Ø§Ø±Ø´\s*/u, '');
            const displayTitle = `Ú¯Ø²Ø§Ø±Ø´ ${cleanTitle}`;
            // Ù†Ù…Ø§ÛŒØ´ ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¨Ù‡ ØªØ±ØªÛŒØ¨: ØªØ§Ø±ÛŒØ® Ø³Ù¾Ø³ ÙˆØ¶Ø¹ÛŒØª
            const filtersLine = `ØªØ§Ø±ÛŒØ®: ${fromDisplay} ØªØ§ ${toDisplay}` + (statusText ? `    ÙˆØ¶Ø¹ÛŒØª: ${statusText}` : '');

            await generatePDF(reportTitle, displayTitle, filtersLine, headers, rows);
        }
        
        let pdfFontLoaded = false;

        async function ensurePdfFont() {
            if (pdfFontLoaded) return;
            try {
                const [regularRes, boldRes] = await Promise.all([
                    fetch('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir-Regular.ttf'),
                    fetch('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir-Bold.ttf')
                ]);

                if (!regularRes.ok || !boldRes.ok) {
                    throw new Error('Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙÙˆÙ†Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯');
                }

                const [regularBuffer, boldBuffer] = await Promise.all([
                    regularRes.arrayBuffer(),
                    boldRes.arrayBuffer()
                ]);

                pdfMake.vfs['Vazir-Regular.ttf'] = arrayBufferToBase64(regularBuffer);
                pdfMake.vfs['Vazir-Bold.ttf'] = arrayBufferToBase64(boldBuffer);
                pdfMake.fonts = {
                    ...(pdfMake.fonts || {}),
                    Vazir: {
                        normal: 'Vazir-Regular.ttf',
                        bold: 'Vazir-Bold.ttf',
                        italics: 'Vazir-Regular.ttf',
                        bolditalics: 'Vazir-Bold.ttf'
                    }
                };

                pdfFontLoaded = true;
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÙˆÙ†Øª PDF:', error);
                throw error;
            }
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            const chunkSize = 0x8000;
            const chunks = [];
            for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                chunks.push(String.fromCharCode.apply(null, chunk));
            }
            return btoa(chunks.join(''));
        }

        function toPersianDigits(str) {
            if (!str) return '';
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            let result = String(str).replace(/\d/g, digit => persianDigits[parseInt(digit)]);
            
            // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø§Ø³Øª (Ø´Ø§Ù…Ù„ /)ØŒ Ù‡Ø± Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù…Ø¹Ú©ÙˆØ³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (result.includes('/')) {
                // Ù‡Ø± Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø¬Ø²Ø§ Ù…Ø¹Ú©ÙˆØ³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                result = result.split('').reverse().join('');
            }
            
            return result;
        }

        function fixRTLText(text, isDate = false) {
            if (!text) return '';
            const str = String(text);
            
            // Ø§Ú¯Ø± Ù…ØªÙ† ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØŒ ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            const hasSlash = str.includes('/');
            const hasOnlyDigitsAndSlash = /^[\d\u06F0-\u06F9\/\s]+$/.test(str.trim());
            
            if (hasSlash && hasOnlyDigitsAndSlash) {
                // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ ØªØ±ØªÛŒØ¨ Ø±Ø§ Ø­ÙØ¸ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                const result = toPersianDigits(str);
                console.log('ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:', str, 'â†’', result);
                return result;
            }
            
            // Ø§Ú¯Ø± Ù…ØªÙ† ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø§Ø³ØªØŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (/^\d+$/.test(str.trim())) {
                return toPersianDigits(str);
            }
            
            // Ø§Ú¯Ø± Ù…ØªÙ† Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªØŒ Ú©Ù„Ù…Ø§Øª Ø±Ø§ Ù…Ø¹Ú©ÙˆØ³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            const persianRegex = /[\u0600-\u06FF]/;
            if (persianRegex.test(str)) {
                // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ù„Ù…Ø§Øª Ùˆ Ù…Ø¹Ú©ÙˆØ³ Ú©Ø±Ø¯Ù† ØªØ±ØªÛŒØ¨ Ø¢Ù†Ù‡Ø§
                const words = str.split(' ');
                return words.reverse().join(' ');
            }
            
            // Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            return toPersianDigits(str);
        }

        // Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ PDF Ø¨Ø§ pdfMake (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ø§Ù…Ù„ ÙØ§Ø±Ø³ÛŒ)
        async function generatePDF(reportTitle, displayTitle, filtersLine, headers, rows) {
            // ØªÙˆÙ„ÛŒØ¯ ØªØ§Ø±ÛŒØ® ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ
            const today = new Date();
            const jDate = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            const currentDate = toPersianDigits(`${jDate.jy}/${String(jDate.jm).padStart(2, '0')}/${String(jDate.jd).padStart(2, '0')}`);

            try {
                await ensurePdfFont();
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÙˆÙ†Øª Ú¯Ø²Ø§Ø±Ø´ PDF. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                return;
            }

            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÙˆÚ¯Ùˆ
            let logoBase64 = '';
            try {
                const response = await fetch('Ù„ÙˆÚ¯Ùˆ Ù¾Ø§Ù„Ø§ÙŠØ´ Ú¯Ø§Ø² Ù‡ÙˆÙŠØ²Ù‡.jpg');
                const blob = await response.blob();
                logoBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÙˆÚ¯Ùˆ:', error);
            }

            const columnCount = headers.length;

            // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ - Ù…Ø¹Ú©ÙˆØ³ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾
            const reversedHeaders = [...headers].reverse();
            const reversedRows = rows.map(row => [...row].reverse());

            const headerRow = reversedHeaders.map(h => ({ 
                text: fixRTLText(h), 
                style: 'tableHeader', 
                alignment: 'center'
            }));
            const dataRows = reversedRows.map(row => row.map(cell => ({ 
                text: fixRTLText(cell ?? ''), 
                alignment: 'center'
            })));

            const tableBody = [headerRow, ...dataRows];
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± header
            const pdfDisplayTitle = displayTitle;
            const pdfFiltersLine = filtersLine;
            
            console.log('PDF Titles:', { displayTitle, filtersLine, pdfDisplayTitle, pdfFiltersLine });

            // ØªØ¹Ø±ÛŒÙ Ø³Ù†Ø¯ PDF
            const docDefinition = {
                pageOrientation: 'landscape',
                pageMargins: [40, 100, 40, 40],
                defaultStyle: {
                    font: 'Vazir',
                    fontSize: 10,
                    alignment: 'center'
                },
                images: {
                    logo: logoBase64
                },
                header: {
                    margin: [40, 20, 40, 0],
                    stack: [
                        {
                            columns: [
                                { image: 'logo', width: 80, alignment: 'left' },
                                { text: '', width: '*' },
                                { text: fixRTLText(`ØªØ§Ø±ÛŒØ® Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´: ${currentDate}`), fontSize: 10, alignment: 'right' }
                            ]
                        }
                    ]
                },
                content: [
                    { text: fixRTLText(pdfDisplayTitle), alignment: 'center', fontSize: 16, bold: true, margin: [0, 4, 0, 4] },
                    { text: fixRTLText(pdfFiltersLine), alignment: 'center', fontSize: 11, margin: [0, 0, 0, 12] },
                    {
                        table: {
                            headerRows: 1,
                            widths: Array(columnCount).fill('*'),
                            body: tableBody
                        },
                        layout: {
                            fillColor: function (rowIndex) {
                                if (rowIndex === 0) return '#4472C4';
                                return (rowIndex >= 1 && rowIndex % 2 === 1) ? '#F8F9FB' : null;
                            },
                            hLineWidth: function () { return 0.5; },
                            vLineWidth: function () { return 0.5; },
                            hLineColor: function () { return '#CCCCCC'; },
                            vLineColor: function () { return '#CCCCCC'; }
                        }
                    }
                ],
                styles: {
                    tableHeader: {
                        bold: true,
                        fontSize: 11,
                        color: 'white',
                        fillColor: '#4472C4',
                        alignment: 'center'
                    }
                }
            };

            pdfMake.createPdf(docDefinition).download(`${reportTitle}_${currentDate}.pdf`);
        }
        
    </script>
</body>
</html>
