<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø± - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item active admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>
                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ - Ø§Ù†Ø¨Ø§Ø±</h1>
            </header>

            <div class="content-section">
                <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
                <div class="filters-section" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                    <div class="form-group" style="margin: 0; flex: 1; max-width: 300px;">
                        <label for="statusFilter">ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª:</label>
                        <select id="statusFilter" class="form-control" onchange="loadWarehouseRequests()">
                            <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                            <option value="ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</option>
                            <option value="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                            <option value="ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                            <option value="Ø±Ø¯ Ø´Ø¯Ù‡">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù…Ø§Ø±Ù‡</th>
                                <th>ÙˆØ§Ø­Ø¯</th>
                                <th>Ú©Ø§Ø±Ø¨Ø±</th>
                                <th>ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ù„Ø§Ù…</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
                                <th>ØªØ§Ø±ÛŒØ® ØªØ§ÛŒÛŒØ¯</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="detailsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª #<span id="detailRequestId"></span></h2>
                <button onclick="closeDetailsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="request-info">
                    <p><strong>ÙˆØ§Ø­Ø¯:</strong> <span id="detailDepartment"></span></p>
                    <p><strong>Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒØ¯Ù‡Ù†Ø¯Ù‡:</strong> <span id="detailUserName"></span></p>
                    <p><strong>ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡:</strong> <span id="detailApprover"></span></p>
                    <p><strong>ØªØ§Ø±ÛŒØ® Ø¯Ø±Ø®ÙˆØ§Ø³Øª:</strong> <span id="detailDate"></span></p>
                    <p><strong>ØªØ§Ø±ÛŒØ® ØªØ§ÛŒÛŒØ¯:</strong> <span id="detailApprovalDate"></span></p>
                    <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø¦ÛŒØ³:</strong> <span id="detailSupervisorComment"></span></p>
                    <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ø±Ø¨Ø±:</strong> <span id="detailDescription"></span></p>
                </div>
                
                <h3>Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ:</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø±Ø¯ÛŒÙ</th>
                                <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="detailItemsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDetailsModal()" class="btn btn-secondary">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <!-- Modal ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ -->
    <div id="checkStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¦ ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ù„Ø§</h2>
                <button onclick="closeCheckStockModal()" class="modal-close">&times;</button>
            </div>
            <form id="checkStockForm" class="modal-form">
                <input type="hidden" id="checkStockRequestId">
                
                <div class="form-group">
                    <label for="checkStockComment">ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="checkStockComment" rows="3" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù‡Ù…Ù‡ Ø§Ù‚Ù„Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">ğŸ“¦ ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
                    <button type="button" onclick="closeCheckStockModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal ØªØ§ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ -->
    <div id="deliverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœ“ ØªØ§ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ</h2>
                <button onclick="closeDeliverModal()" class="modal-close">&times;</button>
            </div>
            <form id="deliverForm" class="modal-form">
                <input type="hidden" id="deliverRequestId">
                
                <div class="form-group">
                    <label for="deliverComment">ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ­ÙˆÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="deliverComment" rows="3" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú©Ø§Ù„Ø§Ù‡Ø§ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">âœ“ ØªØ§ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„</button>
                    <button type="button" onclick="closeDeliverModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h2>
                <button onclick="closeRejectModal()" class="modal-close">&times;</button>
            </div>
            <form id="rejectForm" class="modal-form">
                <input type="hidden" id="rejectRequestId">
                
                <div class="form-group">
                    <label for="rejectComment">Ø¯Ù„ÛŒÙ„ Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="rejectComment" rows="4" placeholder="Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¯Ù„ÛŒÙ„ Ø±Ø¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">âœ— Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
                    <button type="button" onclick="closeRejectModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="api-mock.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            initializeMenu();
            await loadWarehouseRequests();
        })();

        let allRequests = [];

        async function loadWarehouseRequests() {
            try {
                const response = await fetch('http://localhost:3000/api/requests/warehouse/approved');
                const result = await response.json();

                if (result.success && result.requests) {
                    allRequests = result.requests;
                    displayRequests();
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function displayRequests() {
            const tbody = document.getElementById('requestsTableBody');
            
            // Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± ÙˆØ¶Ø¹ÛŒØª
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            let filteredRequests = allRequests;
            
            if (statusFilter) {
                filteredRequests = allRequests.filter(req => req.status === statusFilter);
            }
            
            if (filteredRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }

            tbody.innerHTML = filteredRequests.map(request => {
                const requestDate = new Date(request.created_at).toLocaleDateString('fa-IR');
                const approvalDate = request.supervisor_action_date 
                    ? new Date(request.supervisor_action_date).toLocaleDateString('fa-IR') 
                    : '-';
                
                // ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø±Ù†Ú¯ Ø¨Ø¬
                let statusClass, statusText;
                if (request.status === 'ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³') {
                    statusClass = 'status-pending';
                    statusText = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ';
                } else if (request.status === 'ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ') {
                    statusClass = 'status-approved';
                    statusText = 'Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„';
                } else if (request.status === 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡') {
                    statusClass = 'status-completed';
                    statusText = 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡';
                }
                
                // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª
                let actionButtons = `
                    <button onclick="viewDetails(${request.id})" class="btn-action btn-info" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª">
                        ğŸ‘ï¸
                    </button>
                `;
                
                if (request.status === 'ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³') {
                    // Ù…Ø±Ø­Ù„Ù‡ 1: ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                    actionButtons += `
                        <button onclick="openCheckStockModal(${request.id})" class="btn-action btn-warning" title="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ" style="min-width: 100px;">
                            ğŸ“¦ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                        </button>
                        <button onclick="openRejectModal(${request.id})" class="btn-action btn-danger" title="Ø±Ø¯">
                            âœ—
                        </button>
                    `;
                } else if (request.status === 'ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ') {
                    // Ù…Ø±Ø­Ù„Ù‡ 2: ØªØ§ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„
                    actionButtons += `
                        <button onclick="openDeliverModal(${request.id})" class="btn-action btn-success" title="ØªØ§ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„" style="min-width: 100px;">
                            âœ“ ØªØ­ÙˆÛŒÙ„
                        </button>
                        <button onclick="openRejectModal(${request.id})" class="btn-action btn-danger" title="Ø±Ø¯">
                            âœ—
                        </button>
                    `;
                }
                // Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ú¯Ø´Øª Ø­Ø°Ù Ø´Ø¯ - ÙÙ‚Ø· Ø¯Ø± department-requests Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
                
                return `
                    <tr>
                        <td>${toPersianNumber(request.id)}</td>
                        <td>${request.department_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                        <td>${request.user_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                        <td>${request.approver_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                        <td>${toPersianNumber(request.items_count || 0)}</td>
                        <td>${requestDate}</td>
                        <td>${approvalDate}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function viewDetails(requestId) {
            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}`);
                const result = await response.json();

                if (result.success && result.request) {
                    const request = result.request;
                    const requestDate = new Date(request.created_at).toLocaleDateString('fa-IR');
                    const approvalDate = request.supervisor_action_date 
                        ? new Date(request.supervisor_action_date).toLocaleDateString('fa-IR')
                        : '-';
                    
                    document.getElementById('detailRequestId').textContent = request.id;
                    document.getElementById('detailDepartment').textContent = request.department_name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    document.getElementById('detailUserName').textContent = request.user_name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    document.getElementById('detailApprover').textContent = request.approver_name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    document.getElementById('detailDate').textContent = requestDate;
                    document.getElementById('detailApprovalDate').textContent = approvalDate;
                    document.getElementById('detailSupervisorComment').textContent = request.supervisor_comment || 'Ù†Ø¯Ø§Ø±Ø¯';
                    document.getElementById('detailDescription').textContent = request.description || 'Ù†Ø¯Ø§Ø±Ø¯';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ "ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³")
                    const itemsBody = document.getElementById('detailItemsBody');
                    const isEditable = request.status === 'ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³';
                    
                    if (request.items && request.items.length > 0) {
                        if (isEditable) {
                            // Ø­Ø§Ù„Øª Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ (ÙÙ‚Ø· ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³)
                            itemsBody.innerHTML = request.items.map((item, index) => `
                                <tr id="item-row-${item.id}">
                                    <td>${index + 1}</td>
                                    <td>${item.product_name || item.product_code || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                                    <td>
                                        <input type="number" 
                                               id="quantity-${item.id}" 
                                               value="${item.quantity}" 
                                               min="1" 
                                               style="width: 80px; padding: 5px;"
                                               onchange="updateItemQuantity(${request.id}, ${item.id})">
                                    </td>
                                    <td>${item.description || '-'}</td>
                                    <td>
                                        <button onclick="deleteItem(${request.id}, ${item.id})" 
                                                class="btn-action btn-danger" 
                                                title="Ø­Ø°Ù">
                                            ğŸ—‘ï¸
                                        </button>
                                    </td>
                                </tr>
                            `).join('');
                        } else {
                            // Ø­Ø§Ù„Øª ÙÙ‚Ø· Ø®ÙˆØ§Ù†Ø¯Ù†ÛŒ (ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒØŒ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ùˆ ØºÛŒØ±Ù‡)
                            itemsBody.innerHTML = request.items.map((item, index) => `
                                <tr>
                                    <td>${toPersianNumber(index + 1)}</td>
                                    <td>${item.product_name || item.product_code || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                                    <td>${toPersianNumber(item.quantity)}</td>
                                    <td>${item.description || '-'}</td>
                                    <td>-</td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        itemsBody.innerHTML = '<tr><td colspan="5" class="empty-state">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù„Ø§Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
                    }
                    
                    document.getElementById('detailsModal').classList.add('active');
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        let currentRequestId = null;

        // ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ (Ù…Ø±Ø­Ù„Ù‡ 1)
        function openCheckStockModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('checkStockRequestId').value = requestId;
            document.getElementById('checkStockComment').value = '';
            document.getElementById('checkStockModal').classList.add('active');
        }

        function closeCheckStockModal() {
            document.getElementById('checkStockModal').classList.remove('active');
            currentRequestId = null;
        }

        document.getElementById('checkStockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const requestId = document.getElementById('checkStockRequestId').value;
            const comment = document.getElementById('checkStockComment').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/warehouse-check-stock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comment: comment || 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯',
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯');
                    closeCheckStockModal();
                    await loadWarehouseRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        // ØªØ§ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„ (Ù…Ø±Ø­Ù„Ù‡ 2)
        function openDeliverModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('deliverRequestId').value = requestId;
            document.getElementById('deliverComment').value = '';
            document.getElementById('deliverModal').classList.add('active');
        }

        function closeDeliverModal() {
            document.getElementById('deliverModal').classList.remove('active');
            currentRequestId = null;
        }

        document.getElementById('deliverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const requestId = document.getElementById('deliverRequestId').value;
            const comment = document.getElementById('deliverComment').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/warehouse-deliver`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comment: comment || 'ØªØ­ÙˆÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ',
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
                    closeDeliverModal();
                    await loadWarehouseRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ­ÙˆÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ­ÙˆÛŒÙ„:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        // Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        function openRejectModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('rejectRequestId').value = requestId;
            document.getElementById('rejectComment').value = '';
            document.getElementById('rejectModal').classList.add('active');
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').classList.remove('active');
            currentRequestId = null;
        }

        // Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        document.getElementById('rejectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const requestId = document.getElementById('rejectRequestId').value;
            const comment = document.getElementById('rejectComment').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/warehouse-reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comment: comment,
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø¯ Ø´Ø¯');
                    closeRejectModal();
                    await loadWarehouseRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        // Ø¨Ø±Ú¯Ø´Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        function openReturnModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('returnRequestId').value = requestId;
            document.getElementById('returnComment').value = '';
            document.getElementById('returnModal').classList.add('active');
        }

        function closeReturnModal() {
            document.getElementById('returnModal').classList.remove('active');
            currentRequestId = null;
        }

        // ØªØ§Ø¨Ø¹ ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…
        async function updateItemQuantity(requestId, itemId) {
            console.log('updateItemQuantity called:', requestId, itemId);
            const newQuantity = parseInt(document.getElementById(`quantity-${itemId}`).value);
            
            if (newQuantity < 1) {
                alert('ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
                await viewDetails(requestId); // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQuantity })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Item quantity updated successfully');
                    await viewDetails(requestId); // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ±Ø§Øª
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + result.message);
                    await viewDetails(requestId);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ø¢ÛŒØªÙ…
        async function deleteItem(requestId, itemId) {
            console.log('deleteItem called:', requestId, itemId);
            
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Item deleted successfully');
                    document.getElementById(`item-row-${itemId}`).remove();
                    await viewDetails(requestId); // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ±Ø§Øª
                    await loadWarehouseRequests(); // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + result.message);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }
    </script>
</body>
</html>
