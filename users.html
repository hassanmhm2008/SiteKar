<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item active">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
                <div class="header-actions">
                    <button onclick="openUserModal()" class="btn btn-primary">+ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±</button>
                </div>
            </header>

            <div class="content-section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                                <th>Ù†Ø§Ù… Ú©Ø§Ù…Ù„</th>
                                <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                                <th>Ù†Ù‚Ø´</th>
                                <th>ÙˆØ§Ø­Ø¯</th>
                                <th>Ø§ÛŒÙ…ÛŒÙ„</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <button onclick="closeUserModal()" class="modal-close">&times;</button>
            </div>
            <form id="userForm" class="modal-form">
                <input type="hidden" id="userId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">Ù†Ø§Ù… Ú©Ø§Ù…Ù„ *</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ *</label>
                        <input type="text" id="username" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="password" id="passwordLabel">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± *</label>
                        <input type="password" id="password">
                    </div>
                    <div class="form-group">
                        <label for="role">Ù†Ù‚Ø´ *</label>
                        <select id="role" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                            <option value="Ù…Ø¯ÛŒØ±">Ù…Ø¯ÛŒØ±</option>
                            <option value="Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯">Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯</option>
                            <option value="Ú©Ø§Ø±Ù…Ù†Ø¯">Ú©Ø§Ø±Ù…Ù†Ø¯</option>
                            <option value="Ú©Ø§Ø±Ø´Ù†Ø§Ø³">Ú©Ø§Ø±Ø´Ù†Ø§Ø³</option>
                            <option value="Ø§Ù†Ø¨Ø§Ø± Ø¯Ø§Ø±">Ø§Ù†Ø¨Ø§Ø± Ø¯Ø§Ø±</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="department">ÙˆØ§Ø­Ø¯ *</label>
                        <select id="department" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Ø§ÛŒÙ…ÛŒÙ„</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label for="phone">ØªÙ„ÙÙ†</label>
                        <input type="tel" id="phone">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button type="button" onclick="closeUserModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="api.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            initializeMenu();
        })();
        
        let editingUserId = null;
        let allUsers = [];
        let allDepartments = [];

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        (async function() {
            await loadDepartments();
            await loadUsers();
        })();

        async function loadUsers() {
            try {
                const result = await usersAPI.getAll();
                
                if (result.success) {
                    allUsers = result.users;
                    displayUsers(allUsers);
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:', error);
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="8" class="empty-state">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</td></tr>';
            }
        }

        async function loadDepartments() {
            try {
                const result = await departmentsAPI.getAll();
                
                if (result.success && result.departments) {
                    allDepartments = result.departments;
                    console.log('ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯:', allDepartments.length);
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ§Ø­Ø¯Ù‡Ø§:', result);
                    allDepartments = [];
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§:', error);
                allDepartments = [];
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                return `
                    <tr>
                        <td>${toPersianNumber(user.id)}</td>
                        <td>${user.full_name}</td>
                        <td>${user.username}</td>
                        <td><span class="badge badge-info">${user.role}</span></td>
                        <td>${user.department_name || '-'}</td>
                        <td>${user.email || '-'}</td>
                        <td>
                            <button onclick="editUser(${user.id})" class="btn-icon" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                            <button onclick="deleteUser(${user.id})" class="btn-icon" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function openUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const form = document.getElementById('userForm');
            const modalTitle = document.getElementById('modalTitle');
            
            try {
                form.reset();
                editingUserId = userId;

                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§
                await loadDepartmentsList();

                if (userId) {
                    modalTitle.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±';
                    
                    // Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª
                    const passwordField = document.getElementById('password');
                    const passwordLabel = document.getElementById('passwordLabel');
                    passwordField.removeAttribute('required');
                    passwordLabel.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ Ø§Ú¯Ø± ØªØºÛŒÛŒØ±ÛŒ Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯)';
                    
                    const user = allUsers.find(u => u.id === userId);
                    
                    if (user) {
                        document.getElementById('userId').value = user.id;
                        document.getElementById('fullName').value = user.full_name;
                        document.getElementById('username').value = user.username;
                        document.getElementById('password').value = ''; // Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®Ø§Ù„ÛŒ
                        document.getElementById('role').value = user.role;
                        document.getElementById('department').value = user.department_id || '';
                        document.getElementById('email').value = user.email || '';
                        document.getElementById('phone').value = user.phone || '';
                    }
                } else {
                    modalTitle.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯';
                    
                    // Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª
                    const passwordField = document.getElementById('password');
                    const passwordLabel = document.getElementById('passwordLabel');
                    passwordField.setAttribute('required', 'required');
                    passwordLabel.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± *';
                }
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ±Ù…:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ±Ù… Ú©Ø§Ø±Ø¨Ø±');
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            editingUserId = null;
        }


        async function loadDepartmentsList() {
            const departmentSelect = document.getElementById('department');
            
            if (!departmentSelect) {
                console.error('Ø¹Ù†ØµØ± department Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
                return;
            }
            
            try {
                // Ø§Ú¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
                if (!allDepartments || allDepartments.length === 0) {
                    await loadDepartments();
                }
                
                departmentSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>' +
                    allDepartments.map(dept => 
                        `<option value="${dept.id}">${dept.name}</option>`
                    ).join('');
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§:', error);
                departmentSelect.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§</option>';
            }
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                let result;
                if (editingUserId) {
                    // ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± - ÙÙ‚Ø· ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡
                    const user = allUsers.find(u => u.id === editingUserId);
                    const formData = {};
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const full_name = document.getElementById('fullName').value;
                    const role = document.getElementById('role').value;
                    const department_id = document.getElementById('department').value ? 
                        parseInt(document.getElementById('department').value) : null;
                    const email = document.getElementById('email').value;
                    const phone = document.getElementById('phone').value;
                    
                    console.log('Ù…Ù‚Ø§Ø¯ÛŒØ± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ:', user);
                    console.log('Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯ ÙØ±Ù…:', { username, full_name, role, department_id, email, phone });
                    
                    // ÙÙ‚Ø· ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                    if (username !== user.username) formData.username = username;
                    if (password) formData.password = password; // ÙÙ‚Ø· Ø§Ú¯Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                    if (full_name !== user.full_name) formData.full_name = full_name;
                    if (role !== user.role) formData.role = role;
                    if (department_id !== user.department_id) formData.department_id = department_id;
                    if (email !== (user.email || '')) formData.email = email;
                    if (phone !== (user.phone || '')) formData.phone = phone;
                    
                    console.log('ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡:', formData);
                    
                    if (Object.keys(formData).length === 0) {
                        alert('Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                        return;
                    }
                    
                    result = await usersAPI.update(editingUserId, formData);
                } else {
                    // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                    const formData = {
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value,
                        full_name: document.getElementById('fullName').value,
                        role: document.getElementById('role').value,
                        department_id: document.getElementById('department').value ? 
                            parseInt(document.getElementById('department').value) : null,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value
                    };
                    
                    console.log('Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯:', formData);
                    result = await usersAPI.create(formData);
                }

                if (result.success) {
                    closeUserModal();
                    await loadUsers();
                    alert(editingUserId ? 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        function editUser(userId) {
            openUserModal(userId);
        }

        async function deleteUser(userId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await usersAPI.delete(userId);
                    
                    if (result.success) {
                        await loadUsers();
                        alert('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    } else {
                        alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±');
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±:', error);
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
                }
            }
        }

        function checkAdminMenus() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const adminMenus = document.querySelectorAll('.admin-menu');
            
            if (currentUser && currentUser.role === 'Ù…Ø¯ÛŒØ±') {
                adminMenus.forEach(menu => menu.classList.add('show'));
            } else {
                adminMenus.forEach(menu => menu.classList.remove('show'));
            }
        }

        // Ø¨Ø³ØªÙ† modal Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target === modal) {
                closeUserModal();
            }
        }
    </script>
</body>
</html>
