<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§ - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item active">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§</h1>
                <div class="header-actions">
                    <button onclick="openDepartmentModal()" class="btn btn-primary">+ Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯</button>
                </div>
            </header>

            <div class="content-section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ù†Ø§Ù… ÙˆØ§Ø­Ø¯</th>
                                <th>Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</th>
                                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="departmentsTableBody">
                            <tr>
                                <td colspan="5" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆØ§Ø­Ø¯ -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÛŒØ¯</h2>
                <button onclick="closeDepartmentModal()" class="modal-close">&times;</button>
            </div>
            <form id="departmentForm" class="modal-form">
                <input type="hidden" id="departmentId">
                
                <div class="form-group">
                    <label for="name">Ù†Ø§Ù… ÙˆØ§Ø­Ø¯ *</label>
                    <input type="text" id="name" required>
                </div>

                <div class="form-group">
                    <label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                    <textarea id="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="manager_id">Ù…Ø¯ÛŒØ± ÙˆØ§Ø­Ø¯</label>
                    <select id="manager_id">
                        <option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÛŒØ± ÙˆØ§Ø­Ø¯</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button type="button" onclick="closeDepartmentModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="api.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkCurrentPageAccess();
            await checkPagePermissions();
            initializeMenu();
        })();
        
        let editingDepartmentId = null;

        async function loadDepartments() {
            try {
                const result = await departmentsAPI.getAll();
                
                if (result.success && result.departments) {
                    displayDepartments(result.departments);
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ§Ø­Ø¯Ù‡Ø§:', result);
                    displayDepartments([]);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§:', error);
                displayDepartments([]);
            }
        }

        function displayDepartments(departments) {
            const tbody = document.getElementById('departmentsTableBody');

            if (!departments || departments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Ù‡ÛŒÚ† ÙˆØ§Ø­Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = departments.map(dept => `
                <tr>
                    <td><strong>${dept.name}</strong></td>
                    <td>${dept.manager_name || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡'}</td>
                    <td>${toPersianNumber(dept.user_count)} Ù†ÙØ±</td>
                    <td>${dept.description || '-'}</td>
                    <td>
                        <button onclick="editDepartment(${dept.id})" class="btn-icon" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                        <button onclick="deleteDepartment(${dept.id})" class="btn-icon" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadManagers() {
            try {
                const result = await usersAPI.getAll();
                const managerSelect = document.getElementById('manager_id');
                
                if (result.success && result.users) {
                    managerSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÛŒØ± ÙˆØ§Ø­Ø¯</option>' +
                        result.users.filter(u => u.role === 'Ù…Ø¯ÛŒØ±' || u.role === 'Ø±Ø¦ÛŒØ³ ÙˆØ§Ø­Ø¯')
                            .map(u => `<option value="${u.id}">${u.full_name} (${u.role})</option>`)
                            .join('');
                } else {
                    managerSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÛŒØ± ÙˆØ§Ø­Ø¯</option>';
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯ÛŒØ±Ø§Ù†:', error);
                document.getElementById('manager_id').innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÛŒØ± ÙˆØ§Ø­Ø¯</option>';
            }
        }

        function openDepartmentModal(departmentId = null) {
            const modal = document.getElementById('departmentModal');
            const form = document.getElementById('departmentForm');
            const modalTitle = document.getElementById('modalTitle');
            
            form.reset();
            editingDepartmentId = departmentId;
            loadManagers();

            if (departmentId) {
                modalTitle.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆØ§Ø­Ø¯';
                loadDepartmentData(departmentId);
            } else {
                modalTitle.textContent = 'Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÛŒØ¯';
            }

            modal.style.display = 'flex';
        }

        async function loadDepartmentData(departmentId) {
            try {
                const result = await departmentsAPI.getAll();
                
                if (!result.success || !result.departments) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯');
                    return;
                }
                
                const department = result.departments.find(d => d.id === departmentId);
                
                if (department) {
                    document.getElementById('departmentId').value = department.id;
                    document.getElementById('name').value = department.name;
                    document.getElementById('description').value = department.description || '';
                    document.getElementById('manager_id').value = department.manager_id || '';
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯:', error);
            }
        }

        function closeDepartmentModal() {
            document.getElementById('departmentModal').style.display = 'none';
            editingDepartmentId = null;
        }

        document.getElementById('departmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const departmentData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                manager_id: document.getElementById('manager_id').value || null
            };

            try {
                let result;
                if (editingDepartmentId) {
                    result = await departmentsAPI.update(editingDepartmentId, departmentData);
                } else {
                    result = await departmentsAPI.create(departmentData);
                }
                
                if (result.success) {
                    closeDepartmentModal();
                    await loadDepartments();
                    alert(editingDepartmentId ? 'ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        });

        function editDepartment(departmentId) {
            openDepartmentModal(departmentId);
        }

        async function deleteDepartment(departmentId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ø­Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ\nØªÙˆØ¬Ù‡: ÙÙ‚Ø· ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø±Ø¨Ø± Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù Ù‡Ø³ØªÙ†Ø¯.')) return;

            try {
                const result = await departmentsAPI.delete(departmentId);
                
                if (result.success) {
                    await loadDepartments();
                    alert('ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆØ§Ø­Ø¯');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        loadDepartments();

        window.onclick = function(event) {
            const modal = document.getElementById('departmentModal');
            if (event.target === modal) {
                closeDepartmentModal();
            }
        }
    </script>
</body>
</html>
