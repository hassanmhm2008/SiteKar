<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø± Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <a href="tasks.html" class="nav-item">
                    <span>âœ“</span> Ú©Ø§Ø±Ù‡Ø§
                </a>
                <a href="requests.html" class="nav-item active">
                    <span>ğŸ“¦</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
                </a>
                <a href="department-requests.html" class="nav-item admin-menu" data-page="department-requests">
                    <span>ğŸ“‹</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯
                </a>
                <a href="warehouse-requests.html" class="nav-item admin-menu" data-page="warehouse-requests">
                    <span>ğŸ­</span> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                </a>                
                <div class="nav-item-parent admin-menu" onclick="toggleSubmenu(this)">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </div>
                <div class="nav-submenu admin-menu">
                    <a href="users.html" class="nav-item">
                        <span>ğŸ‘¥</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </a>
                    <a href="departments.html" class="nav-item">
                        <span>ğŸ¢</span> ÙˆØ§Ø­Ø¯Ù‡Ø§
                    </a>
                    <a href="products.html" class="nav-item">
                        <span>ğŸ“‹</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§
                    </a>
                    <a href="permissions.html" class="nav-item">
                        <span>ğŸ”</span> Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span>ğŸ“ˆ</span> Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" id="currentUserInfo">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-role"></span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</h1>
                <div class="header-actions">
                    <button onclick="openRequestModal()" class="btn btn-primary">+ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</button>
                </div>
            </header>

            <div class="content-section">
                <div class="filters">
                    <select id="statusFilter" onchange="filterRequests()">
                        <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                        <option value="Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡">Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡</option>
                        <option value="Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</option>
                        <option value="ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³">ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³</option>
                        <option value="Ø±Ø¯ Ø´Ø¯Ù‡">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                        <option value="ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ">ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                        <option value="ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                        <option value="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
                                <th>Ú©Ø§Ø±Ø¨Ø±</th>
                                <th>ÙˆØ§Ø­Ø¯</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù„Ø§</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="requestModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
                <button onclick="closeRequestModal()" class="modal-close">&times;</button>
            </div>
            <form id="requestForm" class="modal-form">
                <div class="form-group">
                    <label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</label>
                    <textarea id="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù„Ø§Ù‡Ø§</label>
                    <div class="product-selection">
                        <select id="productSelect" style="width: 60%;">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù„Ø§...</option>
                        </select>
                        <input type="number" id="productQuantity" placeholder="ØªØ¹Ø¯Ø§Ø¯" min="1" value="1" style="width: 15%;">
                        <button type="button" onclick="addProduct()" class="btn btn-primary" style="width: 20%;">Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</label>
                    <div id="selectedProducts" class="selected-products-list">
                        <p class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
                    <button type="button" onclick="closeRequestModal()" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
    <div id="requestDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h2>
                <button onclick="closeDetailsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="requestDetailsContent">
                <!-- Ù…Ø­ØªÙˆØ§ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>
            <div class="modal-footer">
                <button onclick="closeDetailsModal()" class="btn btn-secondary">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="api.js"></script>
    <script>
        checkAuth();
        displayCurrentUser();
        
        (async function() {
            await checkPagePermissions();
            initializeMenu();
        })();
        
        let selectedProductsList = [];
        let allProducts = [];

        async function loadRequests() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const filters = {};
                
                console.log('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±:', currentUser);
                
                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³ØªØŒ ÙÙ‚Ø· Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯
                if (currentUser.role !== 'Ù…Ø¯ÛŒØ±') {
                    filters.userId = currentUser.id;
                }

                console.log('ÙÛŒÙ„ØªØ±Ù‡Ø§:', filters);
                const result = await requestsAPI.getAll(filters);
                console.log('Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', result);
                
                if (result.success && result.requests) {
                    displayRequests(result.requests);
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', result);
                    displayRequests([]);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', error);
                displayRequests([]);
            }
        }

        function displayRequests(requests) {
            console.log('Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', requests);
            const tbody = document.getElementById('requestsTableBody');

            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(req => {
                const isEditable = ['Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡'].includes(req.status);
                const isDeletable = ['Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡'].includes(req.status);
                const isSubmittable = ['Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡'].includes(req.status);
                
                let actionButtons = `
                    <button onclick="viewRequestDetails(${req.id})" class="btn-icon" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª">ğŸ‘ï¸</button>
                `;
                
                if (isDeletable) {
                    actionButtons += `<button onclick="deleteRequest(${req.id})" class="btn-icon" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>`;
                }
                
                actionButtons += `<button onclick="copyRequest(${req.id})" class="btn-icon" title="Ú©Ù¾ÛŒ">ğŸ“‹</button>`;
                
                if (isSubmittable) {
                    actionButtons += `<button onclick="submitRequest(${req.id})" class="btn-icon" style="background: #28a745; color: white;" title="Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª">ğŸ“¤</button>`;
                }
                
                return `
                    <tr>
                        <td>${toPersianNumber(req.request_number)}</td>
                        <td>${req.user_name}</td>
                        <td>${req.department_name || '-'}</td>
                        <td>${toPersianNumber(req.total_items)}</td>
                        <td><span class="badge badge-${getRequestStatusClass(req.status)}">${req.status}</span></td>
                        <td>${new Date(req.created_at).toLocaleDateString('fa-IR')}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadProducts() {
            try {
                const result = await productsAPI.getAll({ active: 'true' });
                
                if (result.success && result.products) {
                    allProducts = result.products;
                    
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù„Ø§...</option>' +
                        allProducts.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù„Ø§Ù‡Ø§:', result);
                    allProducts = [];
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§:', error);
                allProducts = [];
            }
        }

        function addProduct() {
            const selectEl = document.getElementById('productSelect');
            const quantityEl = document.getElementById('productQuantity');
            
            const productId = parseInt(selectEl.value);
            const quantity = parseInt(quantityEl.value);

            if (!productId || quantity < 1) {
                showError('Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù„Ø§ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯');
                return;
            }

            const product = allProducts.find(p => p.id === productId);
            
            // Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ
            const existing = selectedProductsList.find(p => p.product_id === productId);
            if (existing) {
                existing.quantity += quantity;
            } else {
                selectedProductsList.push({
                    product_id: productId,
                    product_name: product.name,
                    quantity: quantity,
                    notes: ''
                });
            }

            displaySelectedProducts();
            selectEl.value = '';
            quantityEl.value = 1;
        }

        function displaySelectedProducts() {
            const container = document.getElementById('selectedProducts');
            
            if (selectedProductsList.length === 0) {
                container.innerHTML = '<p class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            container.innerHTML = selectedProductsList.map((item, index) => `
                <div class="selected-product-item">
                    <span>${item.product_name}</span>
                    <span>ØªØ¹Ø¯Ø§Ø¯: ${item.quantity}</span>
                    <button type="button" onclick="removeProduct(${index})" class="btn-icon">âŒ</button>
                </div>
            `).join('');
        }

        function removeProduct(index) {
            selectedProductsList.splice(index, 1);
            displaySelectedProducts();
        }

        async function openRequestModal() {
            selectedProductsList = [];
            await loadProducts();
            document.getElementById('requestForm').reset();
            document.getElementById('selectedProducts').innerHTML = '<p class="empty-state">Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
            document.getElementById('requestModal').style.display = 'flex';
        }

        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
        }

        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (selectedProductsList.length === 0) {
                showError('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                const requestData = {
                    user_id: currentUser.id,
                    department_id: currentUser.department_id,
                    description: document.getElementById('description').value,
                    items: selectedProductsList
                };

                console.log('Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', requestData);
                const result = await requestsAPI.create(requestData);
                console.log('Ù†ØªÛŒØ¬Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', result);
                
                alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
                closeRequestModal();
                
                console.log('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§...');
                await loadRequests();
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
            }
        });

        async function viewRequestDetails(requestId) {
            try {
                const result = await requestsAPI.getById(requestId);
                
                if (!result.success || !result.request) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', result);
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                    return;
                }
                const request = result.request;

                let supervisorSection = '';
                if (request.status === 'Ø±Ø¯ Ø´Ø¯Ù‡' || request.status === 'ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³' || request.status === 'ØªØ§ÛŒÛŒØ¯ Ø§Ù†Ø¨Ø§Ø±' || request.status === 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡') {
                    const actionDate = request.supervisor_action_date 
                        ? new Date(request.supervisor_action_date).toLocaleDateString('fa-IR')
                        : '-';
                    
                    supervisorSection = `
                        <hr style="margin: 15px 0;">
                        <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ§ÛŒÛŒØ¯/Ø±Ø¯:</h3>
                        <p><strong>ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡:</strong> ${request.approver_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                        <p><strong>ØªØ§Ø±ÛŒØ® Ø¨Ø±Ø±Ø³ÛŒ:</strong> ${actionDate}</p>
                        <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø¦ÛŒØ³:</strong> ${request.supervisor_comment || 'Ù†Ø¯Ø§Ø±Ø¯'}</p>
                    `;
                }

                // Ø¨Ø±Ø±Ø³ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´
                const isEditable = ['Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡'].includes(request.status);

                const detailsHTML = `
                    <div class="request-details">
                        <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:</strong> ${request.request_number || request.id}</p>
                        <p><strong>Ú©Ø§Ø±Ø¨Ø±:</strong> ${request.user_name}</p>
                        <p><strong>ÙˆØ§Ø­Ø¯:</strong> ${request.department_name || '-'}</p>
                        <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> <span class="badge badge-${getRequestStatusClass(request.status)}">${request.status}</span></p>
                        <p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${request.description || '-'}</p>
                        <p><strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</strong> ${new Date(request.created_at).toLocaleDateString('fa-IR')}</p>
                        
                        ${supervisorSection}
                        
                        <h3>Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§:</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø±Ø¯ÛŒÙ</th>
                                    <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                                    <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                    ${isEditable ? '<th>Ø¹Ù…Ù„ÛŒØ§Øª</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${request.items && request.items.length > 0 ? request.items.map((item, index) => `
                                    <tr id="item-row-${item.id}">
                                        <td>${toPersianNumber(index + 1)}</td>
                                        <td>${item.product_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                                        <td>
                                            ${isEditable ? `
                                                <input type="number" 
                                                       id="quantity-${item.id}" 
                                                       value="${item.quantity}" 
                                                       min="1" 
                                                       style="width: 80px; padding: 5px;"
                                                       onchange="updateItemQuantity(${request.id}, ${item.id})">
                                            ` : toPersianNumber(item.quantity)}
                                        </td>
                                        ${isEditable ? `
                                            <td>
                                                <button onclick="deleteItemFromRequest(${request.id}, ${item.id})" 
                                                        class="btn-icon" 
                                                        title="Ø­Ø°Ù">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </td>
                                        ` : ''}
                                    </tr>
                                `).join('') : `<tr><td colspan="${isEditable ? 4 : 3}">Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('requestDetailsContent').innerHTML = detailsHTML;
                document.getElementById('requestDetailsModal').style.display = 'flex';
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
            }
        }

        function closeDetailsModal() {
            document.getElementById('requestDetailsModal').style.display = 'none';
        }

        async function deleteRequest(requestId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;

            try {
                await requestsAPI.delete(requestId);
                alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                loadRequests();
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
            }
        }

        async function filterRequests() {
            const status = document.getElementById('statusFilter').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            const filters = {};
            if (status) filters.status = status;
            if (currentUser.role !== 'Ù…Ø¯ÛŒØ±') filters.userId = currentUser.id;

            try {
                const result = await requestsAPI.getAll(filters);
                
                if (result.success && result.requests) {
                    displayRequests(result.requests);
                } else {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± ÙÛŒÙ„ØªØ± Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', result);
                    displayRequests([]);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ÙÛŒÙ„ØªØ± Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§:', error);
                displayRequests([]);
            }
        }

        async function copyRequest(requestId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ú©Ù¾ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/copy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯');
                    await loadRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯
        async function submitRequest(requestId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
                    await loadRequests();
                } else {
                    alert(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ØªØ§Ø¨Ø¹ ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…
        async function updateItemQuantity(requestId, itemId) {
            const newQuantity = parseInt(document.getElementById(`quantity-${itemId}`).value);
            
            if (newQuantity < 1) {
                alert('ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
                await viewRequestDetails(requestId);
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQuantity })
                });

                const result = await response.json();

                if (result.success) {
                    await viewRequestDetails(requestId);
                    await loadRequests();
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + result.message);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ø¢ÛŒØªÙ…
        async function deleteItemFromRequest(requestId, itemId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/requests/${requestId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById(`item-row-${itemId}`).remove();
                    await viewRequestDetails(requestId);
                    await loadRequests();
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + result.message);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function getRequestStatusClass(status) {
            const map = {
                'Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡': 'secondary',
                'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯': 'warning',
                'ØªØ§ÛŒÛŒØ¯ Ø±Ø¦ÛŒØ³': 'success',
                'Ø±Ø¯ Ø´Ø¯Ù‡': 'danger',
                'ØªØ§ÛŒÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ': 'info',
                'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡': 'success',
                'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡': 'secondary',
                // Legacy
                'Ø¬Ø¯ÛŒØ¯': 'new',
                'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ': 'progress',
                'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡': 'completed',
                'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡': 'completed'
            };
            return map[status] || 'new';
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        loadRequests();

        window.onclick = function(event) {
            const modal1 = document.getElementById('requestModal');
            const modal2 = document.getElementById('requestDetailsModal');
            if (event.target === modal1) closeRequestModal();
            if (event.target === modal2) closeDetailsModal();
        }
    </script>
</body>
</html>
